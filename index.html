<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Quinn ‚Äî Command Center</title>
<style>
  :root{ --cyan:#00F0FF; --green:#3BFF88; --purple:#8A7CFF; --bg:#0B1020; --glass:rgba(255,255,255,.08); }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 0%, #121832 0%, #0B1020 60%, #05070e 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e8f7ff}
  a{color:var(--cyan)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);backdrop-filter: blur(10px)}
  .card h2{margin:0;padding:16px 18px 6px;font-size:1.1rem;letter-spacing:.3px}
  .card .body{padding:14px 18px 18px}
  .hud{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){.hud{grid-template-columns: 1.2fr .8fr}}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.15);color:#e6fbff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter: blur(6px);font-weight:600}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 24px rgba(0,240,255,.25)}
  .btn.cyan{box-shadow:0 0 0 0 var(--glass), 0 0 18px rgba(0,240,255,.35)}
  .btn.green{box-shadow:0 0 18px rgba(59,255,136,.35)}
  .tagline{margin:0 0 -6px 2px;color:#8A7CFF;opacity:.9;font-style:italic;text-shadow:0 0 6px rgba(138,124,255,.6),0 0 12px rgba(0,240,255,.35)}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:680px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: radial-gradient(160px 80px at 20% 0%, rgba(0,240,255,.12), rgba(255,255,255,0));box-shadow: inset 0 0 24px rgba(0,240,255,.06)}
  .kpi .label{opacity:.8;font-size:.85rem}
  .kpi .value{font-size:1.6rem;font-weight:700;margin-top:4px}
  .kpi .sub{opacity:.75;font-size:.8rem}
  .table-wrap{border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;text-align:left;font-size:.92rem}
  thead th{position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter: blur(6px);z-index:1}
  tbody tr{border-bottom:1px solid rgba(255,255,255,.08)}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .pill{display:inline-flex;gap:6px;align-items:center;font-size:.75rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  .pill.red{background:rgba(255,59,59,.15);border-color:rgba(255,59,59,.35)}
  .pill.yellow{background:rgba(255,190,70,.12);border-color:rgba(255,190,70,.35)}
  .pill.green{background:rgba(59,255,136,.12);border-color:rgba(59,255,136,.35)}
  .search{display:flex;gap:8px;align-items:center;margin-left:auto}
  .search input{flex:1;min-width:160px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e8f7ff;border-radius:10px;padding:10px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(20,28,48,.95);border:1px solid rgba(255,255,255,.15);color:#e8f7ff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .backdrop{position:fixed;inset:0;background:rgba(5,7,14,.6);backdrop-filter: blur(4px);display:none;align-items:center;justify-content:center;z-index:999}
  .backdrop.show{display:flex}
  .modal{width:min(720px,92vw);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.45)}
  .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px 8px}
  .modal .content{padding:0 16px 16px}
  .grid{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:.85rem;opacity:.9}
  input,select,textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e8f7ff;border-radius:10px;padding:10px}
  textarea{min-height:90px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Quinn ‚Äî Command Center</h2>
    <div class="body">
      <p class="tagline">The eye that sees all ‚Äî one agent to bind all risks and bring them to light.</p>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn cyan" id="btnOpenQuickAudit">‚ûï Quick Audit</button>
        <button class="btn" id="btnRandomAudit">üé≤ Random Audit</button>
        <button class="btn" id="btnInsights">üìä View Insights</button>
        <button class="btn" id="btnRefresh">üîÑ Refresh</button>
        <div class="search"><input id="searchBox" placeholder="Search ticket, owner, issue‚Ä¶"/></div>
      </div>
    </div>
  </div>

  <div class="card"><div class="body">
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">High-Risk Open</div><div class="value" id="kpiHigh">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Medium Risk</div><div class="value" id="kpiMed">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Resolved (7d)</div><div class="value" id="kpiRes7">‚Äì</div><div class="sub">Last 7 days</div></div>
      <div class="kpi"><div class="label">Avg Audit Score (7d)</div><div class="value" id="kpiScore">‚Äì</div><div class="sub">Across audits</div></div>
    </div>
  </div></div>

  <div class="hud">
    <div class="card">
      <h2 style="display:flex;align-items:center;gap:8px">üßØ High-Risk Queue <span class="pill red" id="queueCount">0</span></h2>
      <div class="body"><div class="table-wrap"><table>
        <thead><tr>
          <th style="min-width:140px">Ticket</th><th style="min-width:140px">Owner</th>
          <th style="min-width:110px">Risk</th><th>Issue</th>
          <th style="min-width:120px">Status</th><th style="min-width:160px">Action</th>
        </tr></thead>
        <tbody id="queueBody"></tbody>
      </table></div></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="card">
        <h2>üéõÔ∏è Quick Panels</h2>
        <div class="body" style="display:grid;gap:12px">
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Quick Audit</h2>
            <div class="body">
              <p style="opacity:.85">Launch a lightweight audit: enter a ticket/call/chat ID, score & notes, and save directly to the log.</p>
              <button class="btn green" id="panelQuickAudit">Open Quick Audit</button>
              <button class="btn" id="panelRandomAudit">Random Audit</button>
            </div>
          </div>
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Insights</h2>
            <div class="body">
              <p style="opacity:.85">Open your Looker/Power BI dashboard (set link below).</p>
              <button class="btn" id="panelInsights">Open Insights</button>
            </div>
          </div>
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Slack Smart-Resolve</h2>
            <div class="body">
              <p style="opacity:.85">Use this URL in your Slack alert button (replace placeholders):</p>
              <code style="font-size:.8rem;opacity:.95;word-break:break-all">WEB_APP_URL?fn=resolve&ticket=01-ABC123&by=carol@org.com&token=YOUR_TOKEN&slack=1&redirect=YOUR_SITES_URL</code>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üõ∞Ô∏è Live Audits (auto + manual)</h2>
        <div class="body"><div class="table-wrap"><table>
          <thead><tr>
            <th style="min-width:120px">Time</th><th style="min-width:140px">Ticket</th><th style="min-width:90px">Channel</th>
            <th style="min-width:80px">Score</th><th style="min-width:90px">Risk</th><th style="min-width:120px">Source</th><th>Notes</th>
          </tr></thead>
          <tbody id="recentBody"></tbody>
        </table></div></div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Audit Modal -->
<div class="backdrop" id="auditBackdrop">
  <div class="modal">
    <header><h3 style="margin:0">‚ûï Quick Audit</h3><button class="btn" id="btnCloseModal">‚úñ</button></header>
    <div class="content">
      <div class="grid">
        <div><label>Ticket / Call / Chat ID</label><input id="qa_ticket" placeholder="01-ABC123"/></div>
        <div><label>Channel</label><select id="qa_channel"><option>Ticket</option><option>Call</option><option>Chat</option></select></div>
        <div><label>Owner (optional)</label><input id="qa_owner" placeholder="Owner name"/></div>
        <div><label>Link (optional)</label><input id="qa_link" placeholder="https://‚Ä¶"/></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Score %</label><input id="qa_score" type="number" min="0" max="100" step="0.1" placeholder="85"/></div>
        <div><label>Risk Level</label><select id="qa_risk"><option>Low</option><option>Medium</option><option>High</option></select></div>
      </div>
      <div style="margin-top:8px"><label>Issues / Notes</label><textarea id="qa_issues" placeholder="Key findings, notes, or remediation‚Ä¶"></textarea></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn green" id="btnSaveAudit">Save Audit</button>
        <button class="btn" id="btnRandomFill">üé≤ Random Ticket</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* ====== EDIT THESE THREE (already filled with your values) ====== */
  const WEB_APP_URL = 'https://script.google.com/a/macros/thestudio.com/s/AKfycby43Lj6XA5E07WLplRgRFl7DDRGL9avOj8bX3XMBC7gRIxJSHOuJs8DdJzWQxsZBxOr/exec';
  const TOKEN       = 'QUINN_PORTAL_0c7a5f8f-1e9a-4b34-9b7d-3e6a9c21f4d8';
  const INSIGHTS_URL= 'https://lookerstudio.google.com/reporting/YOUR_REPORT_ID';
  /* =============================================================== */

  // tiny helpers
  const qs = (s,root=document)=>root.querySelector(s);
  const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2400); };

  // JSONP loader (works with domain-restricted Apps Script)
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = '__quinn_cb_' + Math.random().toString(36).slice(2);
      const s  = document.createElement('script');
      const timer = setTimeout(()=>{cleanup(); reject(new Error('timeout'));}, 12000);
      function cleanup(){ delete window[cb]; s.remove(); clearTimeout(timer); }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error('script error')); };
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      document.body.appendChild(s);
    });
  }

  function showAuthHint(){
    const msg = 'Please sign in with your thestudio.com account to use the Command Center.';
    toast('üîê ' + msg);
    const div = document.createElement('div');
    div.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(20,28,48,.95);border:1px solid rgba(255,255,255,.2);padding:10px 12px;border-radius:10px;z-index:9999';
    div.innerHTML = msg + ' <a style="color:#00F0FF" href="'+WEB_APP_URL+'" target="_blank" rel="noopener">Open backend & sign in</a>';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 15000);
  }

  // renderers
  function renderKpis(k){
    qs('#kpiHigh').textContent = k.highOpen ?? k.highRisk ?? '‚Äì';
    qs('#kpiMed').textContent  = k.medOpen  ?? '‚Äì';
    qs('#kpiRes7').textContent = k.resolved7d ?? '‚Äì';
    qs('#kpiScore').textContent= k.avgScore ?? '‚Äì';
  }

  function renderQueue(rows){
    const body = qs('#queueBody'); body.innerHTML = '';
    qs('#queueCount').textContent = rows.length;
    for(const r of rows){
      const riskLabel = r.riskLevel || ((+r.risk>=0.7)?'High':((+r.risk>=0.35)?'Medium':'Low'));
      const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
      const status = r.status || 'Open';
      const ticketText = r.title || r.ticket || '';
      const link = r.link || '#';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
        <td>${r.owner || ''}</td>
        <td><span class="pill ${riskClass}">${riskLabel}</span></td>
        <td title="${(r.issues||'')}">${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'‚Ä¶':''}</td>
        <td>${status}</td>
        <td>
          <button class="btn green" data-ticket="${ticketText}">Resolve</button>
          <button class="btn" onclick="window.open('${link}','_blank')">Open</button>
        </td>`;
      body.appendChild(tr);
    }
    body.querySelectorAll('button.btn.green').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const ticket = e.currentTarget.getAttribute('data-ticket');
        await resolveTicket(ticket);
      });
    });
  }

  async function loadRecentAudits(){
    try{
      const d = await jsonp(`${WEB_APP_URL}?fn=recent`);
      const body = qs('#recentBody'); body.innerHTML = '';
      (d.rows||[]).forEach(x=>{
        const riskClass = (x.riskLevel==='High'?'red':(x.riskLevel==='Medium'?'yellow':'green'));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.time||''}</td>
          <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
          <td>${x.channel||''}</td>
          <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
          <td><span class="pill ${riskClass}">${x.riskLevel||''}</span></td>
          <td>${x.source||''}</td>
          <td title="${(x.issues||'')}">${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'‚Ä¶':''}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ /* silent */ }
  }

  // data loaders via JSONP
  let ALL_ALERTS = [];
  async function loadData(){
    try{
      const data = await jsonp(`${WEB_APP_URL}?fn=alerts`);
      ALL_ALERTS = data.alerts || [];
      renderKpis(data.kpis || {});
      renderQueue(ALL_ALERTS);
      await loadRecentAudits();
    }catch(e){
      showAuthHint();
    }
  }

  // actions (GET endpoints so they work without CORS)
  async function resolveTicket(ticket){
    const manager = (new URLSearchParams(location.search)).get('by') || 'manager@thestudio.com';
    const token   = (new URLSearchParams(location.search)).get('token') || TOKEN;
    try{
      const d = await jsonp(`${WEB_APP_URL}?fn=resolve&ticket=${encodeURIComponent(ticket)}&by=${encodeURIComponent(manager)}&token=${encodeURIComponent(token)}`);
      if(d.ok){ toast('‚úÖ Resolved'); loadData(); } else { toast('‚ö†Ô∏è Could not resolve'); }
    }catch(_){ showAuthHint(); }
  }

  async function saveAudit(){
    const payload = {
      ticket: qs('#qa_ticket').value.trim(),
      channel: qs('#qa_channel').value.trim(),
      owner: qs('#qa_owner').value.trim(),
      link: qs('#qa_link').value.trim(),
      score: qs('#qa_score').value.trim(),
      riskLevel: qs('#qa_risk').value.trim(),
      issues: qs('#qa_issues').value.trim()
    };
    if(!payload.ticket){ toast('Ticket/Call/Chat ID is required'); return; }
    try{
      const u = `${WEB_APP_URL}?fn=submitAudit&token=${encodeURIComponent(TOKEN)}`
        + `&ticket=${encodeURIComponent(payload.ticket)}&channel=${encodeURIComponent(payload.channel)}`
        + `&owner=${encodeURIComponent(payload.owner)}&link=${encodeURIComponent(payload.link)}`
        + `&score=${encodeURIComponent(payload.score)}&riskLevel=${encodeURIComponent(payload.riskLevel)}`
        + `&issues=${encodeURIComponent(payload.issues)}`;
      const d = await jsonp(u);
      if(d.ok){ toast('‚úÖ Audit saved'); closeAuditModal(); loadData(); } else { toast('‚ö†Ô∏è Could not save audit'); }
    }catch(_){ showAuthHint(); }
  }

  async function randomFill(){
    try{
      const d = await jsonp(`${WEB_APP_URL}?fn=random`);
      if(d && d.ticket){ openAuditModal(d); toast('üé≤ Random ticket loaded'); }
      else{ openAuditModal(); toast('No candidates found ‚Äî enter an ID'); }
    }catch(_){ openAuditModal(); showAuthHint(); }
  }

  // modal + wiring
  const backdrop = qs('#auditBackdrop');
  const inputs = {
    ticket: qs('#qa_ticket'), channel: qs('#qa_channel'), owner: qs('#qa_owner'),
    link: qs('#qa_link'), score: qs('#qa_score'), risk: qs('#qa_risk'), issues: qs('#qa_issues')
  };
  function openAuditModal(prefill={}){
    inputs.ticket.value  = prefill.ticket || '';
    inputs.channel.value = prefill.channel || 'Ticket';
    inputs.owner.value   = prefill.owner || '';
    inputs.link.value    = prefill.link || '';
    inputs.score.value   = prefill.score || '';
    inputs.risk.value    = prefill.risk || prefill.riskLevel || 'Low';
    inputs.issues.value  = prefill.issues || '';
    backdrop.classList.add('show');
  }
  function closeAuditModal(){ backdrop.classList.remove('show'); }
  document.getElementById('btnCloseModal').onclick = closeAuditModal;

  document.getElementById('btnOpenQuickAudit').onclick = ()=> openAuditModal();
  document.getElementById('panelQuickAudit').onclick   = ()=> openAuditModal();
  document.getElementById('btnRandomAudit').onclick    = ()=> randomFill();
  document.getElementById('panelRandomAudit').onclick  = ()=> randomFill();
  document.getElementById('btnInsights').onclick       = ()=> window.open(INSIGHTS_URL,'_blank');
  document.getElementById('panelInsights').onclick     = ()=> window.open(INSIGHTS_URL,'_blank');
  document.getElementById('btnRefresh').onclick        = loadData;
  document.getElementById('btnSaveAudit').onclick      = saveAudit;
  document.getElementById('btnRandomFill').onclick     = randomFill;

  // search
  qs('#searchBox').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    if(!q){ renderQueue(ALL_ALERTS); return; }
    const out = ALL_ALERTS.filter(r=>
      (r.title||r.ticket||'').toLowerCase().includes(q) ||
      (r.owner||'').toLowerCase().includes(q) ||
      (r.issues||'').toString().toLowerCase().includes(q) ||
      (r.status||'').toLowerCase().includes(q)
    );
    renderQueue(out);
  });

  // go
  loadData();
  setInterval(loadRecentAudits, 10000);
</script>
</body>
</html>
