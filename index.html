<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Takumi Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d1117;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .grid { display: grid; gap: 1rem; padding: 1rem; }
    .card {
      background: #161b22;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    h2 { margin-top: 0; }

    /* Hero */
    <!-- HERO -->
<div class="card hero">
  <div class="hero-grid">

    <!-- LEFT: text -->
    <div class="hero-copy">
      <h2>Takumi</h2>
      <p class="sysline">THE/STUDIO’s Auto Audit &amp; Redflag System</p>
      <p class="miniTag">The one AI agent to bind all risks and bring them to light...</p>
    </div>

    <!-- RIGHT: Eye -->
    <div id="quinnHost" class="quinn-host">
      <div class="quinn-wrap">
        <div class="quinn">
          <div class="halo"></div>
          <div class="ring"></div>
          <div class="sweep"></div>
          <div class="core"></div>
          <div class="iris"></div>
        </div>
      </div>
    </div>

  </div>
</div>


    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.6rem; border-bottom: 1px solid #333; }
    th { text-align: left; color: #ddd; }
    td a { color: #4fc3f7; text-decoration: none; }
    td a:hover { text-decoration: underline; }

    .pill { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; }
    .pill.red { background: #d32f2f; }
    .pill.yellow { background: #fbc02d; color: #000; }
    .pill.green { background: #388e3c; }

    /* Toast */
    #toast {
      visibility: hidden; min-width: 200px;
      margin-left: -100px; background-color: #333;
      color: #fff; text-align: center; border-radius: 4px;
      padding: 8px; position: fixed; z-index: 1;
      left: 50%; bottom: 30px; font-size: 14px;
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2s; }
    @keyframes fadein { from{bottom:0;opacity:0;} to{bottom:30px;opacity:1;} }
    @keyframes fadeout { from{bottom:30px;opacity:1;} to{bottom:0;opacity:0;} }
  </style>
</head>
<body>
  <div class="grid">
    <!-- Hero -->
    <div class="card hero">
      <div class="hero-grid">
        <!-- LEFT: text -->
        <div class="hero-copy">
          <h2>Takumi</h2>
          <p class="sysline">THE/STUDIO’s Auto Audit &amp; Redflag System</p>
          <p class="miniTag">The one AI agent to bind all risks and bring them to light...</p>
        </div>

        <!-- RIGHT: Eye -->
        <div id="quinnHost" class="quinn-host">
          <div class="quinn-wrap">
            <div class="quinn">
              <div class="halo"></div>
              <div class="ring"></div>
              <div class="sweep"></div>
              <div class="core"></div>
              <div class="iris"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- High-Risk Queue -->
    <div class="card">
      <h2>High-Risk Queue (<span id="queueCount">0</span>)</h2>
      <input id="searchBox" type="text" placeholder="Search..." style="margin-bottom:8px;width:100%;padding:6px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;">
      <div style="overflow-x:auto;">
        <table>
          <thead><tr>
            <th style="min-width:140px">Ticket</th>
            <th style="min-width:140px">Owner</th>
            <th style="min-width:110px">Risk</th>
            <th style="min-width:160px">Issue</th>
            <th style="min-width:140px">Audit Time</th>
            <th style="min-width:140px">Resolution Time</th>
            <th style="min-width:120px">Status</th>
          </tr></thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </div>
    <!-- Live Audits -->
    <div class="card">
      <h2>Live Audits</h2>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr>
            <th>Audit Time</th>
            <th>Ticket</th>
            <th>Channel</th>
            <th>Score</th>
            <th>Risk</th>
            <th>Source</th>
            <th>Issues</th>
            <th>Resolution Time</th>
          </tr></thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>
    </div>

    <div id="toast"></div>
  </div>
<script>
  const WEB_APP_URL = 'YOUR_WEBAPP_URL';  // put your live Apps Script URL here
  const TOKEN       = 'YOUR_TOKEN_HERE';

  const qs = (s,root=document)=>root.querySelector(s);
  const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };

  function fetchFn(fn, params={}) {
    const u = new URL(WEB_APP_URL);
    u.searchParams.set('fn', fn);
    u.searchParams.set('token', TOKEN);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return fetch(u, {mode:'cors'}).then(r=>r.json());
  }

  function riskToLabel(risk, riskLevel){
    if (riskLevel) return riskLevel;
    const n = Number(risk);
    if (!isFinite(n)) return 'Low';
    const pct = n <= 1 ? (n*100) : n;
    if (pct >= 70) return 'High';
    if (pct >= 40) return 'Medium';
    return 'Low';
  }

  function renderQueue(rows){
    const body = qs('#queueBody'); 
    body.innerHTML = '';
    qs('#queueCount').textContent = rows.length;

    rows.forEach(r=>{
      const riskLabel = riskToLabel(r.risk, r.riskLevel);
      const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
      const status = r.status || 'Open';
      const ticketText = r.title || r.ticket || '';
      const link = r.link || '#';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
        <td>${r.owner || ''}</td>
        <td><span class="pill ${riskClass}">${riskLabel}</span></td>
        <td title="${(r.issues||'')}">
          ${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'…':''}
        </td>
        <td>${r.time || '-'}</td>
        <td>${r.resolutionTime || '-'}</td>
        <td>${status}</td>`;
      body.appendChild(tr);
    });
  }

  async function loadData(){
    try{
      const data = await fetchFn('alerts');
      renderQueue(data.alerts || []);
    }catch(e){ toast('⚠️ Could not load alerts'); }
    loadRecentAudits();
  }

  async function loadRecentAudits(){
    try{
      const d = await fetchFn('recent');
      const rows = d?.rows || [];
      const body = qs('#recentBody'); 
      body.innerHTML = '';

      rows.forEach(x=>{
        const label = riskToLabel(x.risk, x.riskLevel);
        const riskClass = (label==='High'?'red':(label==='Medium'?'yellow':'green'));

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.auditTime || x.time || '-'}</td>
          <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
          <td>${x.channel||''}</td>
          <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
          <td><span class="pill ${riskClass}">${label}</span></td>
          <td>${x.source||''}</td>
          <td title="${(x.issues||'')}">
            ${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'…':''}
          </td>
          <td>${x.resolutionTime || '-'}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ console.error(e); }
  }

  qs('#searchBox').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    if(!q) return loadData();
  });

  loadData();
  setInterval(loadRecentAudits, 10000);
</script>
</body>
</html>
