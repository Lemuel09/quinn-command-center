<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Takumi â€” Command Center</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0d1117; color:#fff; }
    .hero { padding:2rem; text-align:center; background:linear-gradient(135deg,#111827,#1f2937); border-radius:12px; margin:1rem; }
    .hero h1 { font-size:2.5rem; margin:0; }
    .hero h2 { font-size:5rem; margin:0.5rem 0; }
    .hero p { font-size:1rem; opacity:0.8; }

    .kpis { display:flex; justify-content:space-around; margin:1rem; }
    .kpi { flex:1; margin:0.5rem; padding:1rem; background:#1e293b; border-radius:8px; text-align:center; }

    .card { background:#1e293b; border-radius:8px; margin:1rem; padding:1rem; }
    .card h2 { margin-top:0; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:0.5rem; text-align:left; border-bottom:1px solid #374151; }
    .pill { padding:0.2rem 0.6rem; border-radius:12px; font-size:0.8rem; }
    .pill.red { background:#dc2626; }
    .pill.yellow { background:#f59e0b; }
    .pill.green { background:#16a34a; }

    .toast { position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:10px; border-radius:6px; opacity:0; transition:opacity 0.3s; }
    .toast.show { opacity:1; }
  </style>
</head>
<body>
  <div class="hero">
    <h1>Takumi â€” Command Center</h1>
    <h2>Takumi</h2>
    <p>THE/STUDIOâ€™s Auto Audit & Redflag System<br>
    <i>The one AI agent to bind all risks and bring them to lightâ€¦</i></p>
  </div>

  <div class="kpis">
    <div class="kpi"><div id="kpiHigh">â€“</div><small>High-Risk Open</small></div>
    <div class="kpi"><div id="kpiMed">â€“</div><small>Medium Risk</small></div>
    <div class="kpi"><div id="kpiRes7">â€“</div><small>Resolved (7d)</small></div>
    <div class="kpi"><div id="kpiScore">â€“</div><small>Avg Audit Score (7d)</small></div>
  </div>

  <div class="card">
    <h2>ðŸ”´ High-Risk Queue <span id="queueCount">0</span></h2>
    <table>
      <thead><tr>
        <th>Ticket</th><th>Owner</th><th>Risk</th><th>Issue</th>
        <th>Audit Time</th><th>Resolution Time</th><th>Status</th><th>Action</th>
      </tr></thead>
      <tbody id="queueBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>ðŸ›  Live Audits (auto + manual)</h2>
    <table>
      <thead><tr>
        <th>Audit Time</th><th>Ticket</th><th>Channel</th><th>Score</th>
        <th>Risk</th><th>Source</th><th>Issue</th><th>Resolution Time</th>
      </tr></thead>
      <tbody id="recentBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>ðŸ”Ž Search</h2>
    <input type="text" id="searchBox" placeholder="Search ticket, owner, issueâ€¦" style="width:100%;padding:0.5rem;">
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ====== CONFIG ====== */
    const WEB_APP_URL = 'https://script.google.com/a/macros/thestudio.com/s/AKfycbyWe3NhOAzFtBOT7IRC2l_eUdoJSZ-Rdc2KPmD2Zd5gUTjTKX0CqZ5y--KoBt3DnKLH/exec';
    const TOKEN       = 'QUINN_1f9a0d7a-6a3e-4a88-94c1-3b02a9e7c4d5';

    // Utilities
    const qs = (s,root=document)=>root.querySelector(s);
    const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };

    // Fetch wrapper (always sends token)
    function fetchFn(fn, params={}) {
      const u = new URL(WEB_APP_URL);
      u.searchParams.set('fn', fn);
      u.searchParams.set('token', TOKEN); // âœ… always include token
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
      return fetch(u, {mode:'cors'}).then(r=>r.json()).catch(e=>{console.error(e); return {};});
    }

    // Risk label
    function riskToLabel(risk, riskLevel){
      if (riskLevel) return riskLevel;
      const n = Number(risk);
      if (!isFinite(n)) return 'Low';
      const pct = n <= 1 ? (n*100) : n;
      if (pct >= 70) return 'High';
      if (pct >= 40) return 'Medium';
      return 'Low';
    }

    // Render KPIs
    function renderKpis(k){
      qs('#kpiHigh').textContent = k.highRisk ?? k.highOpen ?? 'â€“';
      qs('#kpiMed').textContent  = k.medOpen  ?? 'â€“';
      qs('#kpiRes7').textContent = k.resolved7d ?? 'â€“';
      qs('#kpiScore').textContent= k.avgScore7d ?? k.avgScore ?? 'â€“';
    }

    // Render queue
    function renderQueue(rows){
      const body = qs('#queueBody'); 
      body.innerHTML = '';
      qs('#queueCount').textContent = rows.length;

      for(const r of rows){
        const riskLabel = riskToLabel(r.risk, r.riskLevel);
        const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
        const status = r.status || 'Open';
        const ticketText = r.title || r.ticket || '';
        const link = r.link || '#';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
          <td>${r.owner || ''}</td>
          <td><span class="pill ${riskClass}">${riskLabel}</span></td>
          <td title="${(r.issues||'')}">
            ${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'â€¦':''}
          </td>
          <td>${r.auditTime || r.time || '-'}</td>
          <td>${r.resolutionTime || '-'}</td>
          <td>${status}</td>
          <td><button class="btn" onclick="resolveTicket('${ticketText}')">Resolve</button></td>`;
        body.appendChild(tr);
      }
    }

    // Render recent audits
    function renderRecent(rows){
      const body = qs('#recentBody'); 
      body.innerHTML = '';
      rows.forEach(x=>{
        const label = riskToLabel(x.risk, x.riskLevel);
        const riskClass = (label==='High'?'red':(label==='Medium'?'yellow':'green'));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.auditTime || x.time || '-'}</td>
          <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
          <td>${x.channel||''}</td>
          <td>${x.score ?? '-'}</td>
          <td><span class="pill ${riskClass}">${label}</span></td>
          <td>${x.source||''}</td>
          <td title="${(x.issues||'')}">
            ${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'â€¦':''}
          </td>
          <td>${x.resolutionTime || '-'}</td>`;
        body.appendChild(tr);
      });
    }

    // Load data
    async function loadData(){
      try{
        const data = await fetchFn('alerts');
        const alerts = Array.isArray(data.alerts) ? data.alerts : [];
        renderQueue(alerts);
        renderKpis(data.kpis || {});
      }catch(e){ console.error(e); toast('âš ï¸ Could not load alerts/KPIs'); }

      try{
        const d = await fetchFn('recent');
        const rows = d?.rows || (Array.isArray(d) ? d : []);
        renderRecent(rows);
      }catch(e){ console.error(e); }
    }

    // Resolve ticket
    async function resolveTicket(ticket){
      try{
        const res = await fetch(WEB_APP_URL, {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({action:'resolve', ticket, by:'manager@company.com', token:TOKEN})
        }).then(x=>x.json()).catch(()=>null);

        if(res && res.ok){ toast('âœ… Resolved'); loadData(); return; }
        toast('âš ï¸ Could not resolve');
      }catch(_){ toast('âš ï¸ Resolve failed'); }
    }

    // Search
    qs('#searchBox').addEventListener('input', async (e)=>{
      const q = e.target.value.toLowerCase().trim();
      if(!q){ loadData(); return; }
      const data = await fetchFn('alerts');
      const out = (data.alerts||[]).filter(r=>
        (r.title||r.ticket||'').toLowerCase().includes(q) ||
        (r.owner||'').toLowerCase().includes(q) ||
        (r.issues||'').toString().toLowerCase().includes(q) ||
        (r.status||'').toLowerCase().includes(q)
      );
      renderQueue(out);
    });

    // Init
    loadData();
    setInterval(loadData, 15000);
  </script>
</body>
</html>
