<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Takumi ‚Äî Command Center</title>
  <style>
    body { background:#0B1020; color:#e8f7ff; font-family: Inter, sans-serif; margin:0; }
    .wrap{ max-width:1200px; margin:20px auto; padding:0 16px; }
    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; margin-bottom:16px; }
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
    .kpi .label{ opacity:.7; font-size:.85rem }
    .kpi .value{ font-size:1.5rem; font-weight:700; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ border-bottom:1px solid rgba(255,255,255,.15); padding:8px 12px; text-align:left; }
    .pill{ padding:2px 8px; border-radius:999px; font-size:.75rem; }
    .pill.red{ background:rgba(255,59,59,.2); }
    .pill.yellow{ background:rgba(255,190,70,.2); }
    .pill.green{ background:rgba(59,255,136,.2); }
    .toast{ position:fixed; bottom:20px; right:20px; background:#141c30; padding:10px 16px; border-radius:10px; opacity:0; transition:.3s; }
    .toast.show{ opacity:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Takumi ‚Äî Command Center</h1>

    <!-- KPIs -->
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="label">High-Risk Open</div><div class="value" id="kpiHigh">‚Äì</div></div>
        <div class="kpi"><div class="label">Medium Risk</div><div class="value" id="kpiMed">‚Äì</div></div>
        <div class="kpi"><div class="label">Resolved (7d)</div><div class="value" id="kpiRes7">‚Äì</div></div>
        <div class="kpi"><div class="label">Avg Audit Score (7d)</div><div class="value" id="kpiScore">‚Äì</div></div>
      </div>
    </div>

    <!-- High Risk Queue -->
    <div class="card">
      <h2>üßØ High-Risk Queue <span id="queueCount">0</span></h2>
      <table>
        <thead><tr>
          <th>Ticket</th><th>Owner</th><th>Risk</th><th>Issue</th><th>Audit Time</th><th>Resolution Time</th><th>Status</th><th>Action</th>
        </tr></thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>

    <!-- Live Audits -->
    <div class="card">
      <h2>üõ∞Ô∏è Live Audits</h2>
      <table>
        <thead><tr>
          <th>Audit Time</th><th>Ticket</th><th>Channel</th><th>Score</th><th>Risk</th><th>Source</th><th>Issue</th><th>Resolution Time</th>
        </tr></thead>
        <tbody id="recentBody"></tbody>
      </table>
    </div>

    <!-- Search -->
    <div class="card">
      <h2>üîé Search</h2>
      <input id="searchBox" placeholder="Search ticket, owner, issue‚Ä¶" style="width:100%; padding:8px; border-radius:8px;"/>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Your script goes here -->
  <script src="app.js"></script>
</body>
</html>
<script>
  /* ====== EDIT THESE THREE ====== */
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzabzQA1Gs4n9wy_9QDQyVTvFEpkd-3kAJgXlDhFj2AcQpImvfmYJXZ-5qTWNl0qO3I/exec';
  const TOKEN       = 'TAKUMI_PORTAL_0c7a5f8f-1e9a-4b34-9b7d-3e6a9c21f4d8';
  const INSIGHTS_URL= 'https://lookerstudio.google.com/reporting/YOUR_REPORT_ID';
  /* ============================== */

  // Utilities
  const qs = (s,root=document)=>root.querySelector(s);
  const toast = (msg)=>{ 
    const t=qs('#toast'); 
    if(!t) return;
    t.textContent=msg; 
    t.classList.add('show'); 
    setTimeout(()=>t.classList.remove('show'), 2200); 
  };

  // Generic fetch with JSONP fallback
  function fetchFn(fn, params={}) {
    const u = new URL(WEB_APP_URL);
    u.searchParams.set('fn', fn);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return fetch(u, {mode:'cors'})
      .then(r=>r.json())
      .catch(()=> new Promise((resolve,reject)=>{
        const cb = 'cb_'+Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
        const s = document.createElement('script');
        s.src = u.toString() + '&callback=' + cb;
        s.onerror = ()=>{ reject(new Error('jsonp failed')); delete window[cb]; s.remove(); };
        document.body.appendChild(s);
      }));
  }

  // Renderers
  let ALL_ALERTS = [];

  function riskToLabel(risk, riskLevel){
    if (riskLevel) return riskLevel;
    const n = Number(risk);
    if (!isFinite(n)) return 'Low';
    const pct = n <= 1 ? (n*100) : n;
    if (pct >= 70) return 'High';
    if (pct >= 40) return 'Medium';
    return 'Low';
  }

  function renderKpis(k){
    if(qs('#kpiHigh')) qs('#kpiHigh').textContent = k.highRisk ?? k.highOpen ?? '‚Äì';
    if(qs('#kpiMed'))  qs('#kpiMed').textContent  = k.medOpen  ?? '‚Äì';
    if(qs('#kpiRes7')) qs('#kpiRes7').textContent = k.resolved7d ?? '‚Äì';
    if(qs('#kpiScore'))qs('#kpiScore').textContent= k.avgScore7d ?? k.avgScore ?? '‚Äì';
  }

  function renderQueue(rows){
    const body = qs('#queueBody'); 
    if(!body) return;
    body.innerHTML = '';
    if(qs('#queueCount')) qs('#queueCount').textContent = rows.length;

    for(const r of rows){
      const riskLabel = riskToLabel(r.risk, r.riskLevel);
      const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
      const status = r.status || 'Open';
      const ticketText = r.title || r.ticket || '';
      const link = r.link || '#';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
        <td>${r.owner || ''}</td>
        <td><span class="pill ${riskClass}">${riskLabel}</span></td>
        <td title="${(r.issues||'')}">
          ${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'‚Ä¶':''}
        </td>
        <td>${r.auditTime || '-'}</td>
        <td>${r.resolutionTime || '-'}</td>
        <td>${status}</td>
        <td>
          <button class="btn" data-ticket="${ticketText}">Resolve</button>
          <button class="btn" onclick="window.open('${link}','_blank')">Open</button>
        </td>`;
      body.appendChild(tr);
    }

    // Add Resolve button behavior
    body.querySelectorAll('button.btn').forEach(btn=>{
      if(btn.textContent.trim()!=='Resolve') return;
      btn.addEventListener('click', async (e)=>{ 
        await resolveTicket(e.currentTarget.getAttribute('data-ticket')); 
      });
    });
  }

  async function loadData(){
    try{
      const data = await fetchFn('alerts');
      const alerts = Array.isArray(data.alerts) ? data.alerts : [];
      ALL_ALERTS = alerts;
      renderQueue(alerts);
      renderKpis(data.kpis || {});
    }catch(e){ 
      console.error(e); 
      toast('‚ö†Ô∏è Could not load alerts/KPIs'); 
    }
    loadRecentAudits(); // async call (don‚Äôt await)
  }

  async function loadRecentAudits(){
    try{
      const d = await fetchFn('recent');
      const rows = d?.rows || (Array.isArray(d) ? d : []);
      const body = qs('#recentBody'); 
      if(!body) return;
      body.innerHTML = '';

      rows.forEach(x=>{
        const label = riskToLabel(x.risk, x.riskLevel);
        const riskClass = (label==='High'?'red':(label==='Medium'?'yellow':'green'));

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.auditTime || x.time || '-'}</td>
          <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
          <td>${x.channel||''}</td>
          <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
          <td><span class="pill ${riskClass}">${label}</span></td>
          <td>${x.source||''}</td>
          <td title="${(x.issues||'')}">
            ${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'‚Ä¶':''}
          </td>
          <td>${x.resolutionTime || '-'}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ 
      console.error(e); 
    }
  }

  // Quick search
  const searchBox = qs('#searchBox');
  if(searchBox){
    searchBox.addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase().trim();
      if(!q) return renderQueue(ALL_ALERTS);

      const out = ALL_ALERTS.filter(r=>
        (r.title||r.ticket||'').toLowerCase().includes(q) ||
        (r.owner||'').toLowerCase().includes(q) ||
        (r.issues||'').toString().toLowerCase().includes(q) ||
        (r.status||'').toLowerCase().includes(q)
      );
      renderQueue(out);
    });
  }

  // Resolve ticket
  async function resolveTicket(ticket){
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST', mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'resolve', ticket, by:'manager@company.com', token:TOKEN})
      }).then(x=>x.json()).catch(()=>null);

      if(res && res.ok){ 
        toast('‚úÖ Resolved'); 
        loadData(); 
        return; 
      }

      // fallback via JSONP
      const d = await fetchFn('resolve', {ticket, by:'manager@company.com', token:TOKEN});
      if(d && d.ok){ 
        toast('‚úÖ Resolved'); 
        loadData(); 
      } else { 
        toast('‚ö†Ô∏è Could not resolve'); 
      }
    }catch(_){ 
      toast('‚ö†Ô∏è Resolve failed'); 
    }
  }

  // Modal handling
  const backdrop = qs('#auditBackdrop');
  const inputs = {
    ticket: qs('#qa_ticket'), channel: qs('#qa_channel'), owner: qs('#qa_owner'),
    link: qs('#qa_link'), score: qs('#qa_score'), risk: qs('#qa_risk'), issues: qs('#qa_issues')
  };

  function openAuditModal(prefill={}){
    if(!backdrop) return;
    if(inputs.ticket) inputs.ticket.value  = prefill.ticket || '';
    if(inputs.channel) inputs.channel.value = prefill.channel || 'Ticket';
    if(inputs.owner)   inputs.owner.value   = prefill.owner || '';
    if(inputs.link)    inputs.link.value    = prefill.link || '';
    if(inputs.score)   inputs.score.value   = prefill.score || '';
    if(inputs.risk)    inputs.risk.value    = prefill.risk || prefill.riskLevel || 'Low';
    if(inputs.issues)  inputs.issues.value  = prefill.issues || '';
    backdrop.classList.add('show');
  }

  function closeAuditModal(){ 
    if(backdrop) backdrop.classList.remove('show'); 
  }

  const btnClose = document.getElementById('btnCloseModal');
  if(btnClose) btnClose.onclick = closeAuditModal;

  // Save audit
  async function saveAudit(){
    const payload = {
      action:'submitAudit', token: TOKEN,
      ticket: inputs.ticket?.value.trim() || '',
      channel: inputs.channel?.value.trim() || 'Ticket',
      owner: inputs.owner?.value.trim() || '',
      link: inputs.link?.value.trim() || '',
      score: inputs.score?.value.trim() || '',
      riskLevel: inputs.risk?.value.trim() || 'Low',
      issues: inputs.issues?.value.trim() || ''
    };

    if(!payload.ticket){ 
      toast('Ticket/Call/Chat ID is required'); 
      return; 
    }

    try{
      const r = await fetch(WEB_APP_URL, { 
        method:'POST', mode:'cors', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify(payload) 
      }).then(x=>x.json()).catch(()=>null);

      if(r && r.ok){ 
        toast('‚úÖ Audit saved'); 
        closeAuditModal(); 
        loadData(); 
        return; 
      }

      // fallback via JSONP
      const d = await fetchFn('submitAudit', payload);
      if(d && d.ok){ 
        toast('‚úÖ Audit saved'); 
        closeAuditModal(); 
        loadData(); 
      } else { 
        toast('‚ö†Ô∏è Could not save audit'); 
      }
    }catch(e){ 
      console.error(e);
      toast('‚ö†Ô∏è Save failed'); 
    }
  }

  // Random fill
  async function randomFill(){
    try{
      const data = await fetchFn('random');
      if(data && data.ticket){ 
        openAuditModal(data); 
        toast('üé≤ Random ticket loaded'); 
      }
      else{ 
        openAuditModal(); 
        toast('No candidates found ‚Äî enter an ID'); 
      }
    }catch(e){ 
      openAuditModal(); 
      toast('No candidates found ‚Äî enter an ID'); 
    }
  }

  // Bind active buttons
  const btnSave = document.getElementById('btnSaveAudit');
  if(btnSave) btnSave.onclick = saveAudit;

  const btnRandom = document.getElementById('btnRandomFill');
  if(btnRandom) btnRandom.onclick = randomFill;

  // Init
  loadData();
  setInterval(loadRecentAudits, 10000);
</script>
