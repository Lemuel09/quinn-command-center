<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Takumi ‚Äî Command Center</title>
<style>
  :root{
    --bg:#0B1020; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.02);
    --line:rgba(255,255,255,.12); --text:#e8f7ff;
    --cyan:#00E5FF; --green:#46FF9A; --purple:#A88CFF;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 0%, #121832 0%, #0B1020 60%, #05070e 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--cyan);text-decoration:none}
  .wrap{max-width:1200px;margin:18px auto 60px;padding:0 16px}
  .card{background:linear-gradient(180deg, var(--panel), var(--panel2));border:1px solid var(--line);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);backdrop-filter: blur(10px)}
  .card h2{margin:0;padding:16px 18px 6px;font-size:1.1rem;letter-spacing:.3px}
  .card .body{padding:14px 18px 18px}

  /* Title */
  .titlebar{padding:10px 0 2px;text-align:center}
  .titlebar h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,3.2vw,36px)}

  /* HERO */
  .hero{margin-top:10px;padding:18px}
  .hero-grid{display:grid;grid-template-columns:minmax(320px,520px) 1fr;gap:18px;align-items:center}
  @media(max-width:900px){ .hero-grid{grid-template-columns:1fr} }

  .hero-copy h2{margin:0 0 8px;font-weight:900;line-height:.95;
    font-size:clamp(56px,9vw,120px);text-shadow:0 8px 30px rgba(0,0,0,.45), 0 0 24px rgba(0,240,255,.18)}
  .hero-copy .sysline{font-size:1rem;color:#d8e7ff;opacity:.95;margin:0 0 6px}
  .hero-copy .miniTag{font-style:italic;color:#9fb7ff;opacity:.95;margin:0}

  .quinn-host{display:grid;place-items:center}
  .quinn-wrap{position:relative;display:grid;place-items:center;width:min(520px, 92vw);max-width:520px;aspect-ratio:1/1;border-radius:24px;
    background:radial-gradient(220px 160px at 50% 15%, rgba(0,240,255,.10), rgba(0,0,0,0));box-shadow: inset 0 -10px 40px rgba(0,0,0,.35), inset 0 10px 40px rgba(255,255,255,.02)}
  .quinn{position:relative;width:70%;height:70%;filter:drop-shadow(0 12px 28px rgba(0,0,0,.6))}
  /* Takumi Warrior Monk Hat + Eyes */
  .takumi-hat {
    position:absolute;
    inset:60px;
    border-radius:50%;
    background:radial-gradient(circle at 50% 50%, #111 30%, #1a1a1a 60%, transparent 100%);
    border:6px solid var(--cyan);
    box-shadow:0 0 25px var(--cyan), inset 0 0 40px rgba(0,229,255,.4);
    animation:hat-spin 6s linear infinite;
  }
  .takumi-hat::after {
    content:"";
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:25%; height:25%;
    border-radius:50%;
    background:radial-gradient(circle, var(--purple), transparent 70%);
    box-shadow:0 0 20px var(--purple), 0 0 35px var(--cyan);
  }
  .takumi-hat-glow {
    position:absolute;
    inset:50px;
    border-radius:50%;
    border:2px dashed rgba(0,229,255,.5);
    animation:glow-rotate 12s linear infinite;
  }
  .takumi-eyes {
    position:absolute;
    bottom:70px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:40px;
  }
  .takumi-eyes .eye {
    width:22px; height:12px;
    border-radius:50%;
    background:radial-gradient(circle at 50% 40%, #00e5ff 0%, #006a88 70%);
    box-shadow:0 0 15px var(--cyan), 0 0 25px var(--purple);
    animation:eye-glow 2.4s ease-in-out infinite;
  }
  .takumi-eyes .eye.right { animation-delay:1.2s; }

  @keyframes hat-spin {
    from { transform:rotate(0deg); }
    to   { transform:rotate(360deg); }
  }
  @keyframes glow-rotate {
    from { transform:rotate(0deg); }
    to   { transform:rotate(-360deg); }
  }
  @keyframes eye-glow {
    0%,100% { opacity:1; transform:scale(1); }
    50% { opacity:.6; transform:scale(1.15); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <h1>Takumi ‚Äî Command Center</h1>
  </div>

 <div class="card hero">
  <div class="hero-grid">

    <!-- LEFT: text -->
    <div class="hero-copy">
      <h2>Takumi</h2>
      <p class="sysline">THE/STUDIO‚Äôs Quality &amp; AI Red-Flag System</p>
      <p class="miniTag">Crafted with Monozukuri spirit ‚Äî precision AI for risk and quality.</p>

      <!-- Toolbar -->
      <div class="toolbar" style="padding-left:0">
        <button class="btn" id="btnOpenQuickAudit">‚ûï Quick Audit</button>
        <button class="btn" id="btnRandomAudit">üé≤ Random Audit</button>
        <button class="btn" id="btnInsights">üìä View Insights</button>
        <button class="btn" id="btnRefresh">üîÑ Refresh</button>

        <!-- DEMO BUTTONS -->
        <button class="btn" id="btnTicketDemo">üé´ Run Ticket Demo</button>
        <button class="btn" id="btnCallDemo">üìû Run Call Demo</button>
      </div>

      <!-- Status feedback -->
      <div id="demoStatus" style="margin-top:10px;color:var(--green);font-weight:bold;"></div>
    </div>

    <!-- RIGHT: Takumi hat + eyes -->
    <div id="quinnHost" class="quinn-host">
      <div class="quinn-wrap">
        <div class="quinn">
          <div class="takumi-hat"></div>
          <div class="takumi-hat-glow"></div>
          <div class="takumi-eyes">
            <div class="eye left"></div>
            <div class="eye right"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
  <!-- KPIs -->
  <div class="card"><div class="body">
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">High-Risk Open</div><div class="value" id="kpiHigh">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Medium Risk</div><div class="value" id="kpiMed">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Resolved (7d)</div><div class="value" id="kpiRes7">‚Äì</div><div class="sub">Last 7 days</div></div>
      <div class="kpi"><div class="label">Avg Audit Score (7d)</div><div class="value" id="kpiScore">‚Äì</div><div class="sub">Across audits</div></div>
    </div>
  </div></div>

  <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px">
    <div class="card">
      <h2 style="display:flex;align-items:center;gap:8px">üßØ High-Risk Queue <span class="pill red" id="queueCount">0</span></h2>
      <div class="body"><div class="table-wrap"><table>
        <thead><tr>
          <th style="min-width:140px">Ticket</th><th style="min-width:140px">Owner</th>
          <th style="min-width:110px">Risk</th><th>Issue</th>
          <th style="min-width:120px">Status</th><th style="min-width:160px">Action</th>
        </tr></thead>
        <tbody id="queueBody"></tbody>
      </table></div></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="card">
        <h2>üõ∞Ô∏è Live Audits (auto + manual)</h2>
        <div class="body"><div class="table-wrap"><table>
          <thead><tr>
            <th style="min-width:120px">Time</th><th style="min-width:140px">Ticket</th><th style="min-width:90px">Channel</th>
            <th style="min-width:80px">Score</th><th style="min-width:90px">Risk</th><th style="min-width:120px">Source</th><th>Notes</th>
          </tr></thead>
          <tbody id="recentBody"></tbody>
        </table></div></div>
      </div>

      <div class="card">
        <h2>üîé Search</h2>
        <div class="body">
          <div class="toolbar" style="padding:0">
            <div class="search" style="margin:0;width:100%"><input id="searchBox" placeholder="Search ticket, owner, issue‚Ä¶"/></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Audit Modal -->
<div class="backdrop" id="auditBackdrop">
  <div class="modal">
    <header><h3 style="margin:0">‚ûï Quick Audit</h3><button class="btn" id="btnCloseModal">‚úñ</button></header>
    <div class="content">
      <div class="grid">
        <div><label>Ticket / Call / Chat ID</label><input id="qa_ticket" placeholder="01-ABC123"/></div>
        <div><label>Channel</label><select id="qa_channel"><option>Ticket</option><option>Call</option><option>Chat</option></select></div>
        <div><label>Owner (optional)</label><input id="qa_owner" placeholder="Owner name"/></div>
        <div><label>Link (optional)</label><input id="qa_link" placeholder="https://‚Ä¶"/></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Score %</label><input id="qa_score" type="number" min="0" max="100" step="0.1" placeholder="85"/></div>
        <div><label>Risk Level</label><select id="qa_risk"><option>Low</option><option>Medium</option><option>High</option></select></div>
      </div>
      <div style="margin-top:8px"><label>Issues / Notes</label><textarea id="qa_issues" placeholder="Key findings, notes, or remediation‚Ä¶"></textarea></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn" id="btnSaveAudit">Save Audit</button>
        <button class="btn" id="btnRandomFill">üé≤ Random Ticket</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
  /* ====== EDIT THESE THREE ====== */
  const WEB_APP_URL = 'https://script.google.com/a/macros/thestudio.com/s/AKfycbzabzQA1Gs4n9wy_9QDQyVTvFEpkd-3kAJgXlDhFj2AcQpImvfmYJXZ-5qTWNl0qO3I/exec';
  const TOKEN       = 'TAKUMI_PORTAL_0c7a5f8f-1e9a-4b34-9b7d-3e6a9c21f4d8';
  const INSIGHTS_URL= 'https://lookerstudio.google.com/reporting/YOUR_REPORT_ID';
  /* ============================== */

  // === Takumi Eye Tracking ===
  (function(){
    const eyes = document.querySelectorAll('.takumi-eyes .eye');
    const wrap = document.querySelector('.quinn-wrap');

    wrap.addEventListener('mousemove', (e)=>{
      const r = wrap.getBoundingClientRect();
      const x = (e.clientX - (r.left + r.width/2)) / (r.width/2);
      const y = (e.clientY - (r.top + r.height/2)) / (r.height/2);

      eyes.forEach(eye=>{
        eye.style.transform = `translate(${x*6}px, ${y*4}px) scale(1.05)`;
      });
    });
    wrap.addEventListener('mouseleave', ()=>{
      eyes.forEach(eye=>{
        eye.style.transform = 'translate(0,0) scale(1)';
      });
    });
  })();

  // Utilities
  const qs = (s,root=document)=>root.querySelector(s);
  const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };

  // Generic fetch with JSONP fallback
  function fetchFn(fn, params={}) {
    const u = new URL(WEB_APP_URL);
    u.searchParams.set('fn', fn);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return fetch(u, {mode:'cors'})
      .then(r=>r.json())
      .catch(()=> new Promise((resolve,reject)=>{
        const cb = 'cb_'+Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
        const s = document.createElement('script');
        s.src = u.toString() + '&callback=' + cb;
        s.onerror = ()=>{ reject(new Error('jsonp failed')); delete window[cb]; s.remove(); };
        document.body.appendChild(s);
      }));
  }

  // Renderers
  let ALL_ALERTS = [];
  function riskToLabel(risk, riskLevel){
    if (riskLevel) return riskLevel;
    const n = Number(risk);
    if (!isFinite(n)) return 'Low';
    const pct = n <= 1 ? (n*100) : n;
    if (pct >= 70) return 'High';
    if (pct >= 40) return 'Medium';
    return 'Low';
  }

  function renderKpis(k){
    qs('#kpiHigh').textContent = k.highRisk ?? k.highOpen ?? '‚Äì';
    qs('#kpiMed').textContent  = k.medOpen  ?? '‚Äì';
    qs('#kpiRes7').textContent = k.resolved7d ?? '‚Äì';
    qs('#kpiScore').textContent= k.avgScore7d ?? k.avgScore ?? '‚Äì';
  }

  function renderQueue(rows){
    const body = qs('#queueBody'); body.innerHTML = '';
    qs('#queueCount').textContent = rows.length;
    for(const r of rows){
      const riskLabel = riskToLabel(r.risk, r.riskLevel);
      const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
      const status = r.status || 'Open';
      const ticketText = r.title || r.ticket || '';
      const link = r.link || '#';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
        <td>${r.owner || ''}</td>
        <td><span class="pill ${riskClass}">${riskLabel}</span></td>
        <td title="${(r.issues||'')}">${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'‚Ä¶':''}</td>
        <td>${status}</td>
        <td>
          <button class="btn" data-ticket="${ticketText}">Resolve</button>
          <button class="btn" onclick="window.open('${link}','_blank')">Open</button>
        </td>`;
      body.appendChild(tr);
    }
    body.querySelectorAll('button.btn').forEach(btn=>{
      if(btn.textContent.trim()!=='Resolve') return;
      btn.addEventListener('click', async (e)=>{ await resolveTicket(e.currentTarget.getAttribute('data-ticket')); });
    });
  }

  async function loadData(){
    try{
      const data = await fetchFn('alerts');
      const alerts = Array.isArray(data.alerts) ? data.alerts : [];
      ALL_ALERTS = alerts;
      renderQueue(alerts);
      renderKpis(data.kpis || {});
    }catch(e){ console.error(e); toast('‚ö†Ô∏è Could not load alerts/KPIs'); }
    loadRecentAudits(); // do not await
  }

  async function loadRecentAudits(){
    try{
      const d = await fetchFn('recent');
      const rows = d?.rows || (Array.isArray(d) ? d : []);
      const body = qs('#recentBody'); body.innerHTML = '';
      rows.forEach(x=>{
        const label = riskToLabel(x.risk, x.riskLevel);
        const riskClass = (label==='High'?'red':(label==='Medium'?'yellow':'green'));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.time||''}</td>
          <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
          <td>${x.channel||''}</td>
          <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
          <td><span class="pill ${riskClass}">${label}</span></td>
          <td>${x.source||''}</td>
          <td title="${(x.issues||'')}">${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'‚Ä¶':''}</td>`;
        body.appendChild(tr);
      });
    }catch(e){ console.error(e); }
  }

  // Quick search
  qs('#searchBox').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    if(!q) return renderQueue(ALL_ALERTS);
    const out = ALL_ALERTS.filter(r=>
      (r.title||r.ticket||'').toLowerCase().includes(q) ||
      (r.owner||'').toLowerCase().includes(q) ||
      (r.issues||'').toString().toLowerCase().includes(q) ||
      (r.status||'').toLowerCase().includes(q)
    );
    renderQueue(out);
  });

  // Resolve + Quick audit
  async function resolveTicket(ticket){
    try{
      const res = await fetch(WEB_APP_URL, {
        method:'POST', mode:'cors', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'resolve', ticket, by:'manager@company.com', token:TOKEN})
      }).then(x=>x.json()).catch(()=>null);

      if(res && res.ok){ toast('‚úÖ Resolved'); loadData(); return; }

      const d = await fetchFn('resolve', {ticket, by:'manager@company.com', token:TOKEN});
      if(d && d.ok){ toast('‚úÖ Resolved'); loadData(); } else { toast('‚ö†Ô∏è Could not resolve'); }
    }catch(_){ toast('‚ö†Ô∏è Resolve failed'); }
  }

  const backdrop = qs('#auditBackdrop');
  const inputs = {
    ticket: qs('#qa_ticket'), channel: qs('#qa_channel'), owner: qs('#qa_owner'),
    link: qs('#qa_link'), score: qs('#qa_score'), risk: qs('#qa_risk'), issues: qs('#qa_issues')
  };
  function openAuditModal(prefill={}){
    inputs.ticket.value  = prefill.ticket || '';
    inputs.channel.value = prefill.channel || 'Ticket';
    inputs.owner.value   = prefill.owner || '';
    inputs.link.value    = prefill.link || '';
    inputs.score.value   = prefill.score || '';
    inputs.risk.value    = prefill.risk || prefill.riskLevel || 'Low';
    inputs.issues.value  = prefill.issues || '';
    backdrop.classList.add('show');
  }
  function closeAuditModal(){ backdrop.classList.remove('show'); }
  document.getElementById('btnCloseModal').onclick = closeAuditModal;

  async function saveAudit(){
    const payload = {
      action:'submitAudit', token: TOKEN,
      ticket: inputs.ticket.value.trim(),
      channel: inputs.channel.value.trim(),
      owner: inputs.owner.value.trim(),
      link: inputs.link.value.trim(),
      score: inputs.score.value.trim(),
      riskLevel: inputs.risk.value.trim(),
      issues: inputs.issues.value.trim()
    };
    if(!payload.ticket){ toast('Ticket/Call/Chat ID is required'); return; }

    try{
      const r = await fetch(WEB_APP_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(x=>x.json()).catch(()=>null);
      if(r && r.ok){ toast('‚úÖ Audit saved'); closeAuditModal(); loadData(); return; }
      const d = await fetchFn('submitAudit', payload);
      if(d && d.ok){ toast('‚úÖ Audit saved'); closeAuditModal(); loadData(); } else { toast('‚ö†Ô∏è Could not save audit'); }
    }catch(e){ toast('‚ö†Ô∏è Save failed'); }
  }

  async function randomFill(){
    try{
      const data = await fetchFn('random');
      if(data && data.ticket){ openAuditModal(data); toast('üé≤ Random ticket loaded'); }
      else{ openAuditModal(); toast('No candidates found ‚Äî enter an ID'); }
    }catch(e){ openAuditModal(); toast('No candidates found ‚Äî enter an ID'); }
  }

  document.getElementById('btnOpenQuickAudit').onclick = ()=> openAuditModal();
  document.getElementById('btnRandomAudit').onclick    = ()=> randomFill();
  document.getElementById('btnInsights').onclick       = ()=> window.open(INSIGHTS_URL,'_blank');
  document.getElementById('btnRefresh').onclick        = loadData;
  document.getElementById('btnSaveAudit').onclick      = saveAudit;
  document.getElementById('btnRandomFill').onclick     = randomFill;

  // === DEMO BUTTONS ===
  document.getElementById('btnTicketDemo').onclick = async () => {
    qs('#demoStatus').textContent = "‚è≥ Running Ticket Demo...";
    try {
      const res = await fetchFn('runTicketDemo');
      qs('#demoStatus').textContent = res || "‚úÖ Ticket Demo done";
      loadData();
    } catch (e) {
      qs('#demoStatus').textContent = "‚ùå Ticket Demo failed";
    }
  };

  document.getElementById('btnCallDemo').onclick = async () => {
    qs('#demoStatus').textContent = "‚è≥ Running Call Demo...";
    try {
      const res = await fetchFn('runCallDemo');
      qs('#demoStatus').textContent = res || "‚úÖ Call Demo done";
      loadData();
    } catch (e) {
      qs('#demoStatus').textContent = "‚ùå Call Demo failed";
    }
  };

  loadData();
  setInterval(loadRecentAudits, 10000);
</script>
</body>
</html>
