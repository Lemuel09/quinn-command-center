<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Takumi — Command Center</title>
<style>
  :root{
    --bg:#0B1020; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.02);
    --line:rgba(255,255,255,.12); --text:#e8f7ff; --cyan:#00E5FF; --green:#46FF9A; --purple:#A88CFF;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 0%, #121832 0%, #0B1020 60%, #05070e 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--cyan);text-decoration:none}
  .wrap{max-width:1200px;margin:18px auto 60px;padding:0 16px}
  .card{background:linear-gradient(180deg, var(--panel), var(--panel2));border:1px solid var(--line);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);backdrop-filter: blur(10px)}
  .card h2{margin:0;padding:16px 18px 6px;font-size:1.1rem;letter-spacing:.3px}
  .card .body{padding:14px 18px 18px}

  /* Title */
  .titlebar{padding:10px 0 2px;text-align:center}
  .titlebar h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,3.2vw,36px)}

  /* HERO */
  .hero{margin-top:10px;padding:18px}
  .hero-grid{display:grid;grid-template-columns:minmax(320px,520px) 1fr;gap:18px;align-items:center}
  @media(max-width:900px){ .hero-grid{grid-template-columns:1fr} }

  .hero-copy h2{margin:0 0 8px;font-weight:900;line-height:.95;
    font-size:clamp(56px,9vw,120px);text-shadow:0 8px 30px rgba(0,0,0,.45), 0 0 24px rgba(0,240,255,.18)}
  .hero-copy .sysline{font-size:1rem;color:#d8e7ff;opacity:.95;margin:0 0 6px}
  .hero-copy .miniTag{font-style:italic;color:#9fb7ff;opacity:.95;margin:0}

  .quinn-host{display:grid;place-items:center}
  .quinn-wrap{position:relative;display:grid;place-items:center;width:min(520px, 92vw);max-width:520px;aspect-ratio:1/1;border-radius:24px;
    background:radial-gradient(220px 160px at 50% 15%, rgba(0,240,255,.10), rgba(0,0,0,0));box-shadow: inset 0 -10px 40px rgba(0,0,0,.35), inset 0 10px 40px rgba(255,255,255,.02)}
  .quinn{position:relative;width:70%;height:70%;filter:drop-shadow(0 12px 28px rgba(0,0,0,.6))}
  .ring{position:absolute;inset:0;border-radius:50%;background:
    conic-gradient(from 0deg, rgba(255,255,255,.15) 0 10deg, rgba(255,255,255,.04) 10deg 30deg, rgba(255,255,255,.15) 30deg 45deg, rgba(255,255,255,.04) 45deg 70deg, rgba(255,255,255,.15) 70deg 90deg, rgba(255,255,255,.04) 90deg 130deg, rgba(255,255,255,.15) 130deg 150deg, rgba(255,255,255,.04) 150deg 210deg, rgba(255,255,255,.15) 210deg 230deg, rgba(255,255,255,.04) 230deg 270deg, rgba(255,255,255,.15) 270deg 300deg, rgba(255,255,255,.04) 300deg 360deg),
    radial-gradient(closest-side, rgba(255,255,255,.18), rgba(255,255,255,.06) 60%, rgba(0,0,0,.5) 100%); box-shadow:inset 0 0 0 2px rgba(255,255,255,.08), inset 0 0 40px rgba(138,124,255,.15);
    animation:spin 10s linear infinite}
  .sweep{position:absolute;inset:3px;border-radius:50%;background:conic-gradient(from var(--sweep-from,0deg), transparent 0deg, rgba(0,240,255,.18) 30deg, rgba(59,255,136,.18) 45deg, transparent 80deg);filter: blur(2px) drop-shadow(0 0 16px rgba(0,240,255,.45));mix-blend-mode:screen;opacity:.5;animation:sweep 5.6s linear infinite}
  .core{position:absolute;inset:26px;border-radius:50%;background:
    radial-gradient(120px 120px at 50% 45%, rgba(0,240,255,.35), rgba(0,240,255,.08) 60%, rgba(0,0,0,.55) 100%),
    radial-gradient(100px 70px at 55% 40%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
    radial-gradient(80px 40px at 40% 60%, rgba(255,255,255,.25), rgba(255,255,255,0) 55%),
    radial-gradient(closest-side, #041018, #060d14 60%, #02060a 100%);
    box-shadow: inset 0 0 40px rgba(0,240,255,.25), inset 0 0 70px rgba(59,255,136,.18), 0 0 40px rgba(0,240,255,.35);
    animation:breathe 3.6s ease-in-out infinite}
  .iris{position:absolute;inset:78px;border-radius:50%;background:radial-gradient(circle at 50% 45%, rgba(0,240,255,.85), rgba(0,240,255,.15) 45%, rgba(0,0,0,.8) 70%);box-shadow: 0 0 24px rgba(0,240,255,.35), inset 0 0 30px rgba(0,240,255,.55);animation:iris-pulse 5s ease-in-out infinite}
  .halo{position:absolute;inset:-14px;border-radius:50%;background: radial-gradient(closest-side, rgba(0,240,255,.12), rgba(0,0,0,0));filter: blur(8px);mix-blend-mode:screen}
  @keyframes spin {to{transform:rotate(360deg)}}
  @keyframes sweep {to{--sweep-from:360deg}}
  @keyframes breathe {0%,100%{transform:scale(1)}50%{transform:scale(1.025)}}
  @keyframes iris-pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

  /* TOOLBAR */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:8px 0 0}
  .btn{appearance:none;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.15);color:#e6fbff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter: blur(6px);font-weight:600}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 24px rgba(0,240,255,.25)}

  /* KPI + tables */
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:680px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: radial-gradient(160px 80px at 20% 0%, rgba(0,240,255,.12), rgba(255,255,255,0));box-shadow: inset 0 0 24px rgba(0,240,255,.06)}
  .kpi .label{opacity:.8;font-size:.85rem}
  .kpi .value{font-size:1.6rem;font-weight:700;margin-top:4px}
  .kpi .sub{opacity:.75;font-size:.8rem}
  .table-wrap{border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;text-align:left;font-size:.92rem}
  thead th{position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter: blur(6px);z-index:1}
  tbody tr{border-bottom:1px solid rgba(255,255,255,.08)}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .pill{display:inline-flex;gap:6px;align-items:center;font-size:.75rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  .pill.red{background:rgba(255,59,59,.15);border-color:rgba(255,59,59,.35)}
  .pill.yellow{background:rgba(255,190,70,.12);border-color:rgba(255,190,70,.35)}
  .pill.green{background:rgba(59,255,136,.12);border-color:rgba(59,255,136,.35)}

  /* Modal + toast */
  .backdrop{position:fixed;inset:0;background:rgba(5,7,14,.6);backdrop-filter: blur(4px);display:none;align-items:center;justify-content:center;z-index:999}
  .backdrop.show{display:flex}
  .modal{width:min(720px,92vw);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.45)}
  .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px 8px}
  .modal .content{padding:0 16px 16px}
  .grid{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:.85rem;opacity:.9}
  input,select,textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e8f7ff;border-radius:10px;padding:10px}
  textarea{min-height:90px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(20,28,48,.95);border:1px solid rgba(255,255,255,.15);color:#e8f7ff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  /* Smooth fade-out effect for resolved rows */
.fade-out {
  opacity: 0;
  transform: translateY(4px);
  transition: opacity 0.4s ease, transform 0.4s ease;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <h1>Takumi — Command Center</h1>
  </div>

 <div class="card hero">
  <div class="hero-grid">

    <!-- LEFT: text -->
    <div class="hero-copy">
      <h2>Takumi</h2>
      <p class="sysline">THE/STUDIO’s Quality &amp; AI Red Flag System</p>
      <p class="miniTag">Crafted with Monozukuri spirit — precision AI for risk and quality.</p>
 </div> <!-- ✅ properly close hero-copy -->

    <!-- RIGHT: eye -->
    <div id="quinnHost" class="quinn-host">
      <div class="quinn-wrap">
        <div class="quinn">
          <div class="halo"></div>
          <div class="ring"></div>
          <div class="sweep"></div>
          <div class="core"></div>
          <div class="iris"></div>
        </div>
      </div>
    </div>

  </div>
</div>


  <!-- KPIs -->
  <div class="card"><div class="body">
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">High-Risk Open</div><div class="value" id="kpiHigh">–</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Medium Risk</div><div class="value" id="kpiMed">–</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Resolved (7d)</div><div class="value" id="kpiRes7">–</div><div class="sub">Last 7 days</div></div>
      <div class="kpi"><div class="label">Avg Audit Score (7d)</div><div class="value" id="kpiScore">–</div><div class="sub">Across audits</div></div>
    </div>
  </div></div>

  <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px">
  <div class="card">
    <h2 style="display:flex;align-items:center;gap:8px">
      🧯 High-Risk Queue <span class="pill red" id="queueCount">0</span>
    </h2>
    <div class="body">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:140px">Ticket</th>
              <th style="min-width:120px">Date</th>
              <th style="min-width:140px">Owner</th>
              <th style="min-width:110px">Risk</th>
              <th>Issue</th>
              <th style="min-width:120px">Status</th>
              <th style="min-width:140px">Resolved By</th>      <!-- ✅ NEW -->
              <th style="min-width:200px">Resolution Note</th>  <!-- ✅ NEW -->
              <th style="min-width:160px">Action</th>
            </tr>
          </thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="card">
        <h2>🛰️ Live Audits (auto + manual)</h2>
        <div class="body"><div class="table-wrap"><table>
          <thead><tr>
            <th style="min-width:120px">Time</th><th style="min-width:140px">Ticket</th><th style="min-width:90px">Channel</th>
            <th style="min-width:80px">Score</th><th style="min-width:90px">Risk</th><th style="min-width:120px">Source</th><th>Notes</th>
          </tr></thead>
          <tbody id="recentBody"></tbody>
        </table></div></div>
      </div>

      <div class="card">
        <h2>🔎 Search</h2>
        <div class="body">
          <div class="toolbar" style="padding:0">
            <div class="search" style="margin:0;width:100%"><input id="searchBox" placeholder="Search ticket, owner, issue…"/></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Audit Modal -->
<div class="backdrop" id="auditBackdrop">
  <div class="modal">
    <header><h3 style="margin:0">➕ Quick Audit</h3><button class="btn" id="btnCloseModal">✖</button></header>
    <div class="content">
      <div class="grid">
        <div><label>Ticket / Call / Chat ID</label><input id="qa_ticket" placeholder="01-ABC123"/></div>
        <div><label>Channel</label><select id="qa_channel"><option>Ticket</option><option>Call</option><option>Chat</option></select></div>
        <div><label>Owner (optional)</label><input id="qa_owner" placeholder="Owner name"/></div>
        <div><label>Link (optional)</label><input id="qa_link" placeholder="https://…"/></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Score %</label><input id="qa_score" type="number" min="0" max="100" step="0.1" placeholder="85"/></div>
        <div><label>Risk Level</label><select id="qa_risk"><option>Low</option><option>Medium</option><option>High</option></select></div>
      </div>
      <div style="margin-top:8px"><label>Issues / Notes</label><textarea id="qa_issues" placeholder="Key findings, notes, or remediation…"></textarea></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn" id="btnSaveAudit">Save Audit</button>
        <button class="btn" id="btnRandomFill">🎲 Random Ticket</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* ====== EDIT THESE THREE ====== */
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyxAy35lS-hKN1kWO5Gbju3O734UyI9PzccXJGF8fzu380a9vR2bTl_nD-7JfXcphQO/exec';
  const TOKEN       = 'QUINN_PORTAL_0c7a5f8f-1e9a-4b34-9b7d-3e6a9c21f4d8';
  const INSIGHTS_URL= 'https://lookerstudio.google.com/reporting/YOUR_REPORT_ID';
  /* ============================== */

  // Eye parallax
  (function(){
    const iris = document.querySelector('.iris');
    const rectEl = document.querySelector('.quinn-wrap');
    rectEl.addEventListener('mousemove', (e)=>{
      const r = rectEl.getBoundingClientRect();
      const x = (e.clientX - (r.left + r.width/2)) / (r.width/2);
      const y = (e.clientY - (r.top + r.height/2)) / (r.height/2);
      iris.style.transform = `translate(${x*4}px, ${y*3}px) scale(1.02)`;
    });
    rectEl.addEventListener('mouseleave', ()=>{ iris.style.transform = 'translate(0,0) scale(1)'; });
  })();

  // Utilities
  const qs = (s,root=document)=>root.querySelector(s);
  const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };

  // Generic fetch with JSONP fallback
  function fetchFn(fn, params={}){
    const u = new URL(WEB_APP_URL);
    u.searchParams.set('fn', fn);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return fetch(u, {mode:'cors'})
      .then(r=>r.json())
      .catch(()=> new Promise((resolve,reject)=>{
        const cb = 'cb_'+Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
        const s = document.createElement('script');
        s.src = u.toString() + '&callback=' + cb;
        s.onerror = ()=>{ reject(new Error('jsonp failed')); delete window[cb]; s.remove(); };
        document.body.appendChild(s);
      }));
  }

  // Renderers
  let ALL_ALERTS = [];
  function riskToLabel(risk, riskLevel){
    if (riskLevel) return riskLevel;
    const n = Number(risk);
    if (!isFinite(n)) return 'Low';
    // Accept 0..1 or 0..100
    const pct = n <= 1 ? (n*100) : n;
    if (pct >= 70) return 'High';
    if (pct >= 40) return 'Medium';
    return 'Low';
  }

  function renderKpis(k){
    qs('#kpiHigh').textContent = k.highRisk ?? k.highOpen ?? '–';
    qs('#kpiMed').textContent  = k.medOpen  ?? '–';
    qs('#kpiRes7').textContent = k.resolved7d ?? '–';
    qs('#kpiScore').textContent= k.avgScore7d ?? k.avgScore ?? '–';
  }


  function renderQueue(rows){
  const body = qs('#queueBody'); 
  body.innerHTML = '';
  qs('#queueCount').textContent = rows.length;

  // 🔽 Sort newest to oldest by time
  rows.sort((a,b)=>{
    const da = new Date(a.time || 0);
    const db = new Date(b.time || 0);
    return db - da;
  });

  for(const r of rows){
   const riskLabel = riskToLabel(r.risk, r.riskLevel);
    const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
    const status = r.status || 'Open';
    const ticketText = r.title || r.ticket || '';
    const link = r.link || '#';

    // ✅ values coming from backend
    const resolvedBy = r.resolvedBy || '';
    const resolutionNote = r.resolutionNote || '';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
      <td>${r.time || '-'}</td>
      <td>${r.owner || ''}</td>
      <td><span class="pill ${riskClass}">${riskLabel}</span></td>
      <td title="${(r.issues||'')}">${(r.issues||'').toString().slice(0,80)}${(r.issues||'').toString().length>80?'…':''}</td>
      <td>${status}</td>
      <td>${resolvedBy}</td>
      <td title="${resolutionNote}">${resolutionNote.toString().slice(0,60)}${resolutionNote.length>60?'…':''}</td>
      <td>
        <textarea class="resolutionNote" placeholder="Enter resolution note…" 
          style="width:180px; height:40px; resize:vertical;"></textarea>
        <button class="btn resolveBtn" data-ticket="${ticketText}">Resolve</button>
        <button class="btn" onclick="window.open('${link}','_blank')">Open</button>
      </td>`;
    body.appendChild(tr);
  }

  // ✅ Hook up Resolve button with note capture
  body.querySelectorAll('button.resolveBtn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{ 
      const ticket = e.currentTarget.getAttribute('data-ticket');
      const note = e.currentTarget.closest('td').querySelector('.resolutionNote')?.value || '';
      await resolveTicket(ticket, note); 
    });
  });
}

async function loadData(){
  try {
    const res = await fetch(`${WEB_APP_URL}?fn=alerts&token=${TOKEN}`);
    const data = await res.json();

    if (!data || !data.ok) {
      toast('⚠️ Failed to load data');
      return;
    }

    ALL_ALERTS = data.alerts;   // keep full set for search

    // ✅ Only show unresolved HIGH-RISK rows
    const rows = ALL_ALERTS.filter(r => {
      const status = String(r.status || '').toLowerCase();
      const risk = (r.riskLevel || r.risk || '').toString().toLowerCase();
      return status !== 'resolved' && risk.includes('high');
    });

    renderQueue(rows);
  } catch (err) {
    toast('⚠️ Load failed');
  }
}

  async function loadRecentAudits(){
  try {
    const d = await fetchFn('recent');
    console.log("DEBUG raw recent response:", d);

    // ✅ handle different possible response shapes
    const rows = d?.rows || d?.recent || (Array.isArray(d) ? d : []);
    console.log("DEBUG parsed rows:", rows);

    // 🔽 Sort newest to oldest by auditTime or time
    rows.sort((a,b)=>{
      const da = new Date(a.auditTime || a.time || 0);
      const db = new Date(b.auditTime || b.time || 0);
      return db - da;
    });

    const body = qs('#recentBody'); 
    body.innerHTML = '';
    rows.forEach(x=>{
      const label = riskToLabel(x.risk, x.riskLevel);  // ✅ use riskLevel
      const riskClass = (label==='High'?'red':(label==='Medium'?'yellow':'green'));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.time||x.auditTime||''}</td>
        <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
        <td>${x.channel||''}</td>
        <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
        <td><span class="pill ${riskClass}">${label}</span></td>
        <td>${x.source||''}</td>
        <td title="${(x.issues||'')}">${(x.issues||'').toString().slice(0,80)}${(x.issues||'').toString().length>80?'…':''}</td>`;
      body.appendChild(tr);
    });

  } catch(e) { 
    console.error("ERROR in loadRecentAudits:", e); 
    toast('⚠️ Could not load recent audits');
  }
}


  // Quick search
  qs('#searchBox').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    if(!q) return renderQueue(ALL_ALERTS);
    const out = ALL_ALERTS.filter(r=>
      (r.title||r.ticket||'').toLowerCase().includes(q) ||
      (r.owner||'').toLowerCase().includes(q) ||
      (r.issues||'').toString().toLowerCase().includes(q) ||
      (r.status||'').toLowerCase().includes(q)
    );
    renderQueue(out);
  });

  // Resolve + Quick audit
  async function resolveTicket(ticket, note = "") {
  try {
    // Find the table row for visual effect
    const btn = document.querySelector(`button.resolveBtn[data-ticket="${ticket}"]`);
    const tr = btn ? btn.closest("tr") : null;

    const payload = {
      action: "resolve",
      ticket,
      note,
      token: TOKEN
    };

    // First try standard POST
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(x => x.json()).catch(() => null);

    const ok = res && res.ok;

    if (ok) {
      toast(`✅ Resolved by ${res.resolvedBy || "You"}`);

      // 🔽 Apply fade-out before removing
      if (tr) {
        tr.classList.add("fade-out");
        setTimeout(() => tr.remove(), 500);
      }

      // Reload queue so it stays fresh
      setTimeout(loadData, 700);
      return;
    }

    // JSONP fallback
    const d = await fetchFn("resolve", payload);
    if (d && d.ok) {
      toast(`✅ Resolved by ${d.resolvedBy || "You"}`);
      if (tr) {
        tr.classList.add("fade-out");
        setTimeout(() => tr.remove(), 500);
      }
      setTimeout(loadData, 700);
    } else {
      toast("⚠️ Could not resolve");
    }
  } catch (err) {
    toast("⚠️ Resolve failed");
    console.error("Resolve error:", err);
  }
}



  function openAuditModal(prefill={}){
    inputs.ticket.value  = prefill.ticket || '';
    inputs.channel.value = prefill.channel || 'Ticket';
    inputs.owner.value   = prefill.owner || '';
    inputs.link.value    = prefill.link || '';
    inputs.score.value   = prefill.score || '';
    inputs.risk.value    = prefill.risk || prefill.risklevel || 'Low';
    inputs.issues.value  = prefill.issues || '';
    backdrop.classList.add('show');
  }
  function closeAuditModal(){ backdrop.classList.remove('show'); }
  document.getElementById('btnCloseModal').onclick = closeAuditModal;

  async function saveAudit(){
    const payload = {
      action:'submitAudit', token: TOKEN,
      ticket: inputs.ticket.value.trim(),
      channel: inputs.channel.value.trim(),
      owner: inputs.owner.value.trim(),
      link: inputs.link.value.trim(),
      score: inputs.score.value.trim(),
      risklevel: inputs.risk.value.trim(),
      issues: inputs.issues.value.trim()
    };
    if(!payload.ticket){ toast('Ticket/Call/Chat ID is required'); return; }

    try{
      const r = await fetch(WEB_APP_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(x=>x.json()).catch(()=>null);
      if(r && r.ok){ toast('✅ Audit saved'); closeAuditModal(); loadData(); return; }
      const d = await fetchFn('submitAudit', payload);
      if(d && d.ok){ toast('✅ Audit saved'); closeAuditModal(); loadData(); } else { toast('⚠️ Could not save audit'); }
    }catch(e){ toast('⚠️ Save failed'); }
  }

  async function randomFill(){
    try{
      const data = await fetchFn('random');
      if(data && data.ticket){ openAuditModal(data); toast('🎲 Random ticket loaded'); }
      else{ openAuditModal(); toast('No candidates found — enter an ID'); }
    }catch(e){ openAuditModal(); toast('No candidates found — enter an ID'); }
  }

// === BUTTON SAFEGUARDS ===

// Quick Audit modal
const btnCloseModal = document.getElementById('btnCloseModal');
if (btnCloseModal) btnCloseModal.onclick = closeAuditModal;

const btnOpenQuickAudit = document.getElementById('btnOpenQuickAudit');
if (btnOpenQuickAudit) btnOpenQuickAudit.onclick = () => openAuditModal();

const btnRandomAudit = document.getElementById('btnRandomAudit');
if (btnRandomAudit) btnRandomAudit.onclick = () => randomFill();

const btnSaveAudit = document.getElementById('btnSaveAudit');
if (btnSaveAudit) btnSaveAudit.onclick = saveAudit;

const btnRandomFill = document.getElementById('btnRandomFill');
if (btnRandomFill) btnRandomFill.onclick = randomFill;

const btnInsights = document.getElementById('btnInsights');
if (btnInsights) btnInsights.onclick = () => window.open(INSIGHTS_URL, '_blank');

const btnRefresh = document.getElementById('btnRefresh');
if (btnRefresh) btnRefresh.onclick = loadData;

// === DEMO BUTTONS (optional) ===
const btnTicketDemo = document.getElementById('btnTicketDemo');
if (btnTicketDemo) {
  btnTicketDemo.onclick = async () => {
    qs('#demoStatus').textContent = "⏳ Running Ticket Demo...";
    try {
      const res = await fetchFn('runTicketDemo');
      qs('#demoStatus').textContent = res || "✅ Ticket Demo done";
      loadData();
    } catch (e) {
      qs('#demoStatus').textContent = "❌ Ticket Demo failed";
    }
  };
}

const btnCallDemo = document.getElementById('btnCallDemo');
if (btnCallDemo) {
  btnCallDemo.onclick = async () => {
    qs('#demoStatus').textContent = "⏳ Running Call Demo...";
    try {
      const res = await fetchFn('runCallDemo');
      qs('#demoStatus').textContent = res || "✅ Call Demo done";
      loadData();
    } catch (e) {
      qs('#demoStatus').textContent = "❌ Call Demo failed";
    }
  };
}

  loadData();
  setInterval(loadRecentAudits, 10000);
</script>
</body>
</html>
