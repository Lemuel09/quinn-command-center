<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Quinn ‚Äî Command Center</title>
<style>
  :root{
    --cyan:#00F0FF; --green:#3BFF88; --purple:#8A7CFF; --bg:#0B1020; --glass:rgba(255,255,255,.08);
    --danger:#FF3B3B; --muted:rgba(255,255,255,.7);
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 0%, #121832 0%, #0B1020 60%, #05070e 100%);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e8f7ff}
  a{color:var(--cyan)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.1);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: blur(10px)}
  .card h2{margin:0;padding:16px 18px 6px;font-size:1.1rem;letter-spacing:.3px}
  .card .body{padding:14px 18px 18px}
  .hud{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){.hud{grid-template-columns: 1.2fr .8fr}}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.15);
    color:#e6fbff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter: blur(6px);font-weight:600}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 24px rgba(0,240,255,.25)}
  .btn.cyan{box-shadow:0 0 0 0 var(--glass), 0 0 18px rgba(0,240,255,.35)}
  .btn.green{box-shadow:0 0 18px rgba(59,255,136,.35)}
  .tagline{margin:0 0 -6px 2px;color:#8A7CFF;opacity:.9;font-style:italic;text-shadow:0 0 6px rgba(138,124,255,.6),0 0 12px rgba(0,240,255,.35)}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:680px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: radial-gradient(160px 80px at 20% 0%, rgba(0,240,255,.12), rgba(255,255,255,0));box-shadow: inset 0 0 24px rgba(0,240,255,.06)}
  .kpi .label{opacity:.8;font-size:.85rem}
  .kpi .value{font-size:1.6rem;font-weight:700;margin-top:4px}
  .kpi .sub{opacity:.75;font-size:.8rem}
  .table-wrap{border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;text-align:left;font-size:.92rem}
  thead th{position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter: blur(6px);z-index:1}
  tbody tr{border-bottom:1px solid rgba(255,255,255,.08)}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .pill{display:inline-flex;gap:6px;align-items:center;font-size:.75rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  .pill.red{background:rgba(255,59,59,.15);border-color:rgba(255,59,59,.35)}
  .pill.yellow{background:rgba(255,190,70,.12);border-color:rgba(255,190,70,.35)}
  .pill.green{background:rgba(59,255,136,.12);border-color:rgba(59,255,136,.35)}
  .search{display:flex;gap:8px;align-items:center;margin-left:auto}
  .search input{flex:1;min-width:160px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e8f7ff;border-radius:10px;padding:10px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(20,28,48,.95);border:1px solid rgba(255,255,255,.15);color:#e8f7ff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .backdrop{position:fixed;inset:0;background:rgba(5,7,14,.6);backdrop-filter: blur(4px);display:none;align-items:center;justify-content:center;z-index:999}
  .backdrop.show{display:flex}
  .modal{width:min(720px,92vw);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.45)}
  .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px 8px}
  .modal .content{padding:0 16px 16px}
  .grid{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:.85rem;opacity:.9}
  input,select,textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e8f7ff;border-radius:10px;padding:10px}
  textarea{min-height:90px}

  /* mini Quinn eye */
  .quinn-wrap{position:relative;display:grid;place-items:center;width:220px;height:220px;margin:10px;border-radius:18px;background:radial-gradient(160px 120px at 50% 15%, rgba(0,240,255,.12), rgba(0,0,0,0));box-shadow: inset 0 -10px 40px rgba(0,0,0,.35), inset 0 10px 40px rgba(255,255,255,.02)}
  .quinn{position:relative;width:170px;height:170px;filter: drop-shadow(0 12px 28px rgba(0,0,0,.6));}
  .ring{position:absolute;inset:0;border-radius:50%;background:
    conic-gradient(from 0deg, rgba(255,255,255,.15) 0 10deg, rgba(255,255,255,.04) 10deg 30deg, rgba(255,255,255,.15) 30deg 45deg, rgba(255,255,255,.04) 45deg 70deg, rgba(255,255,255,.15) 70deg 90deg, rgba(255,255,255,.04) 90deg 130deg, rgba(255,255,255,.15) 130deg 150deg, rgba(255,255,255,.04) 150deg 210deg, rgba(255,255,255,.15) 210deg 230deg, rgba(255,255,255,.04) 230deg 270deg, rgba(255,255,255,.15) 270deg 300deg, rgba(255,255,255,.04) 300deg 360deg),
    radial-gradient(closest-side, rgba(255,255,255,.18), rgba(255,255,255,.06) 60%, rgba(0,0,0,.5) 100%);
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.08), inset 0 0 40px rgba(138,124,255,.15);
    animation: spin 10s linear infinite;
  }
  .sweep{position:absolute;inset:3px;border-radius:50%;background:conic-gradient(from var(--sweep-from,0deg), transparent 0deg, rgba(0,240,255,.18) 30deg, rgba(59,255,136,.18) 45deg, transparent 80deg);filter: blur(2px) drop-shadow(0 0 16px rgba(0,240,255,.45));mix-blend-mode:screen;opacity:.35;animation: sweep 6s linear infinite;}
  .core{position:absolute;inset:20px;border-radius:50%;background:
    radial-gradient(90px 90px at 50% 45%, rgba(0,240,255,.35), rgba(0,240,255,.08) 60%, rgba(0,0,0,.55) 100%),
    radial-gradient(100px 70px at 55% 40%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
    radial-gradient(80px 40px at 40% 60%, rgba(255,255,255,.25), rgba(255,255,255,0) 55%),
    radial-gradient(closest-side, #041018, #060d14 60%, #02060a 100%);
    box-shadow: inset 0 0 40px rgba(0,240,255,.25), inset 0 0 70px rgba(59,255,136,.18), 0 0 40px rgba(0,240,255,.35);
    animation: breathe 3.5s ease-in-out infinite;
  }
  .iris{position:absolute;inset:60px;border-radius:50%;background:radial-gradient(circle at 50% 45%, rgba(0,240,255,.85), rgba(0,240,255,.15) 45%, rgba(0,0,0,.8) 70%);
    box-shadow: 0 0 24px rgba(0,240,255,.35), inset 0 0 30px rgba(0,240,255,.55); animation: iris-pulse 5s ease-in-out infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes sweep{to{--sweep-from:360deg}}
  @keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
  @keyframes iris-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

  .center{min-height:60vh;display:grid;place-items:center}
  .mini-card{padding:22px 18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 30px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap" id="app">

  <div class="card">
    <h2 style="display:flex;align-items:center;gap:12px">
      <span>Quinn ‚Äî Command Center</span>
      <span class="pill">v1 ‚Ä¢ static portal</span>
    </h2>
    <div class="body" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
      <div class="quinn-wrap">
        <div class="quinn">
          <div class="ring"></div>
          <div class="sweep"></div>
          <div class="core"></div>
          <div class="iris"></div>
        </div>
      </div>
      <div style="flex:1 1 420px;min-width:280px">
        <p class="tagline">The eye that sees all ‚Äî one agent to bind all risks and bring them to light.</p>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn cyan" id="btnOpenQuickAudit">‚ûï Quick Audit</button>
          <button class="btn" id="btnRandomAudit">üé≤ Random Audit</button>
          <button class="btn" id="btnInsights">üìä View Insights</button>
          <button class="btn" id="btnRefresh">üîÑ Refresh</button>
          <div class="search"><input id="searchBox" placeholder="Search ticket, owner, issue‚Ä¶"/></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card"><div class="body">
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">High-Risk Open</div><div class="value" id="kpiHigh">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Medium Risk</div><div class="value" id="kpiMed">‚Äì</div><div class="sub">Unresolved</div></div>
      <div class="kpi"><div class="label">Resolved (7d)</div><div class="value" id="kpiRes7">‚Äì</div><div class="sub">Last 7 days</div></div>
      <div class="kpi"><div class="label">Avg Audit Score (7d)</div><div class="value" id="kpiScore">‚Äì</div><div class="sub">Across audits</div></div>
    </div>
  </div></div>

  <div class="hud">
    <div class="card">
      <h2 style="display:flex;align-items:center;gap:8px">üßØ High-Risk Queue <span class="pill red" id="queueCount">0</span></h2>
      <div class="body"><div class="table-wrap"><table>
        <thead><tr>
          <th style="min-width:140px">Ticket</th><th style="min-width:140px">Owner</th>
          <th style="min-width:110px">Risk</th><th>Issue</th>
          <th style="min-width:120px">Status</th><th style="min-width:160px">Action</th>
        </tr></thead>
        <tbody id="queueBody"></tbody>
      </table></div></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="card">
        <h2>üéõÔ∏è Quick Panels</h2>
        <div class="body" style="display:grid;gap:12px">
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Quick Audit</h2>
            <div class="body">
              <p style="opacity:.85">Launch a lightweight audit: enter a ticket/call/chat ID, score & notes, and save directly to the log.</p>
              <button class="btn green" id="panelQuickAudit">Open Quick Audit</button>
              <button class="btn" id="panelRandomAudit">Random Audit</button>
            </div>
          </div>
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Insights</h2>
            <div class="body">
              <p style="opacity:.85">Open your Looker/BI dashboard.</p>
              <button class="btn" id="panelInsights">Open Insights</button>
            </div>
          </div>
          <div class="card" style="border-radius:14px">
            <h2 style="font-size:1rem">Slack Smart-Resolve</h2>
            <div class="body">
              <p style="opacity:.85">Button URL example (replace ticket & by):</p>
              <code style="font-size:.8rem;opacity:.95;word-break:break-all" id="slackUrl"></code>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üõ∞Ô∏è Live Audits (auto + manual)</h2>
        <div class="body"><div class="table-wrap"><table>
          <thead><tr>
            <th style="min-width:120px">Time</th><th style="min-width:140px">Ticket</th><th style="min-width:90px">Channel</th>
            <th style="min-width:80px">Score</th><th style="min-width:90px">Risk</th><th style="min-width:120px">Source</th><th>Notes</th>
          </tr></thead>
          <tbody id="recentBody"></tbody>
        </table></div></div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Audit Modal -->
<div class="backdrop" id="auditBackdrop">
  <div class="modal">
    <header><h3 style="margin:0">‚ûï Quick Audit</h3><button class="btn" id="btnCloseModal">‚úñ</button></header>
    <div class="content">
      <div class="grid">
        <div><label>Ticket / Call / Chat ID</label><input id="qa_ticket" placeholder="01-ABC123"/></div>
        <div><label>Channel</label><select id="qa_channel"><option>Ticket</option><option>Call</option><option>Chat</option></select></div>
        <div><label>Owner (optional)</label><input id="qa_owner" placeholder="Owner name"/></div>
        <div><label>Link (optional)</label><input id="qa_link" placeholder="https://‚Ä¶"/></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Score %</label><input id="qa_score" type="number" min="0" max="100" step="0.1" placeholder="85"/></div>
        <div><label>Risk Level</label><select id="qa_risk"><option>Low</option><option>Medium</option><option>High</option></select></div>
      </div>
      <div style="margin-top:8px"><label>Issues / Notes</label><textarea id="qa_issues" placeholder="Key findings, notes, or remediation‚Ä¶"></textarea></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn green" id="btnSaveAudit">Save Audit</button>
        <button class="btn" id="btnRandomFill">üé≤ Random Ticket</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Slack resolve mini page -->
<div id="slackMini" style="display:none" class="center">
  <div class="mini-card" id="slackMiniCard">Working‚Ä¶</div>
</div>

<script>
/* ==================== CONFIG (filled for you) ==================== */
const API_BASE     = 'https://script.google.com/macros/s/AKfycbyvChHj3u4GOg204UR3Y58pMyxEDGNcklHXabKTQMhZ7UOZ7kQ_AkLZKMEQymJLyTjd/exec';
const TOKEN        = 'QUINN_PORTAL_0c7a5f8f-1e9a-4b34-9b7d-3e6a9c21f4d8';
const INSIGHTS_URL = 'https://lookerstudio.google.com/reporting/YOUR_REPORT_ID';
const SITE_URL     = location.href.split('?')[0];
/* ================================================================ */

const qs = (s,root=document)=>root.querySelector(s);
const toast = (msg)=>{ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };
let ALL_ALERTS = [];

/* ---- JSONP helper (bypasses CORS) ---- */
function jsonp(fnOrAction, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    window[cb] = (data) => {
      try { resolve(data); } finally {
        delete window[cb];
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }
    };
    const url = new URL(API_BASE);
    if (fnOrAction === 'resolve' || fnOrAction === 'submitAudit') {
      url.searchParams.set('action', fnOrAction);
    } else {
      url.searchParams.set('fn', fnOrAction);
    }
    for (const [k, v] of Object.entries(params)) {
      if (v !== undefined && v !== null) url.searchParams.set(k, String(v));
    }
    url.searchParams.set('callback', cb);

    const script = document.createElement('script');
    script.src = url.toString();
    script.onerror = () => { delete window[cb]; reject(new Error('JSONP failed')); };
    document.body.appendChild(script);
  });
}

/* -------- API adapter (Apps Script via JSONP) -------- */
const API = {
  alerts(){ return jsonp('alerts'); },
  recent(){ return jsonp('recent'); },
  random(){ return jsonp('random'); },
  resolve(ticket, by){ return jsonp('resolve', { ticket, by, token: TOKEN }); },
  submitAudit(payload){ return jsonp('submitAudit', { token: TOKEN, ...payload }); }
};

/* -------- Renderers -------- */
function renderKpis(k){
  qs('#kpiHigh').textContent = k.highRisk ?? k.highOpen ?? '‚Äì';
  qs('#kpiMed').textContent  = k.medOpen  ?? '‚Äì';
  qs('#kpiRes7').textContent = k.resolved7d ?? '‚Äì';
  qs('#kpiScore').textContent= k.avgScore7d ?? k.avgScore ?? '‚Äì';
}
function renderQueue(rows){
  const body = qs('#queueBody'); body.innerHTML = '';
  qs('#queueCount').textContent = rows.length;
  for(const r of rows){
    const riskVal = Number(r.risk ?? (r.riskLevel==='High'?80:(r.riskLevel==='Medium'?50:20)));
    const riskLabel = r.riskLevel || (riskVal>=70?'High':(riskVal>=35?'Medium':'Low'));
    const riskClass = riskLabel==='High' ? 'red' : (riskLabel==='Medium' ? 'yellow' : 'green');
    const status = r.status || 'Open';
    const ticketText = r.title || r.ticket || '';
    const link = r.link || '#';
    const issuesText = (typeof r.issues==='string') ? r.issues : (Array.isArray(r.issues)? r.issues.map(i=>i.description||i.category||'').join('; ') : JSON.stringify(r.issues||''));
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="${link}" target="_blank" rel="noopener">${ticketText}</a></td>
      <td>${r.owner || ''}</td>
      <td><span class="pill ${riskClass}">${riskLabel}</span></td>
      <td title="${issuesText}">${issuesText.slice(0,80)}${issuesText.length>80?'‚Ä¶':''}</td>
      <td>${status}</td>
      <td>
        <button class="btn green" data-ticket="${ticketText}">Resolve</button>
        <button class="btn" onclick="window.open('${link}','_blank')">Open</button>
      </td>`;
    body.appendChild(tr);
  }
  body.querySelectorAll('button.btn.green').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const ticket = e.currentTarget.getAttribute('data-ticket');
      const manager = 'manager@company.com';
      const res = await API.resolve(ticket, manager);
      if(res.ok){ toast('‚úÖ Resolved'); loadAll(); } else { toast('‚ö†Ô∏è Could not resolve'); }
    });
  });
}
function renderRecent(rows){
  const body = qs('#recentBody'); body.innerHTML='';
  (rows||[]).forEach(x=>{
    const riskClass = (x.riskLevel==='High'?'red':(x.riskLevel==='Medium'?'yellow':'green'));
    const issuesText = (typeof x.issues==='string') ? x.issues : (Array.isArray(x.issues)? x.issues.map(i=>i.description||i.category||'').join('; ') : '');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.time||x.created_at||''}</td>
      <td><a href="${x.link||'#'}" target="_blank" rel="noopener">${x.title||x.ticket||''}</a></td>
      <td>${x.channel||''}</td>
      <td>${(x.score===undefined||x.score==='')?'-':x.score}</td>
      <td><span class="pill ${riskClass}">${x.riskLevel||''}</span></td>
      <td>${x.source||''}</td>
      <td title="${issuesText}">${issuesText.slice(0,80)}${issuesText.length>80?'‚Ä¶':''}</td>`;
    body.appendChild(tr);
  });
}

/* -------- Data loaders -------- */
async function loadAll(){
  try{
    const data = await API.alerts();
    ALL_ALERTS = data.alerts || [];
    renderQueue(ALL_ALERTS);
    renderKpis(data.kpis || {});
  }catch(e){ console.error(e); toast('‚ö†Ô∏è Could not load alerts/KPIs'); }
  try{
    const d = await API.recent();
    renderRecent(d.rows || d.data || d || []);
  }catch(e){ /* ignore */ }
}

/* -------- Quick Audit modal -------- */
const backdrop = qs('#auditBackdrop');
const inputs = {
  ticket: qs('#qa_ticket'), channel: qs('#qa_channel'), owner: qs('#qa_owner'),
  link: qs('#qa_link'), score: qs('#qa_score'), risk: qs('#qa_risk'), issues: qs('#qa_issues')
};
function openAuditModal(prefill={}){
  inputs.ticket.value  = prefill.ticket || '';
  inputs.channel.value = prefill.channel || 'Ticket';
  inputs.owner.value   = prefill.owner || '';
  inputs.link.value    = prefill.link || '';
  inputs.score.value   = prefill.score || '';
  inputs.risk.value    = prefill.risk || 'Low';
  inputs.issues.value  = prefill.issues || '';
  backdrop.classList.add('show');
}
function closeAuditModal(){ backdrop.classList.remove('show'); }

async function saveAudit(){
  const payload = {
    ticket: inputs.ticket.value.trim(),
    channel: inputs.channel.value.trim(),
    owner: inputs.owner.value.trim(),
    link: inputs.link.value.trim(),
    score: inputs.score.value ? Number(inputs.score.value) : undefined,
    riskLevel: inputs.risk.value,
    issues: inputs.issues.value.trim()
  };
  if(!payload.ticket){ toast('Ticket/Call/Chat ID is required'); return; }
  try{
    const data = await API.submitAudit(payload);
    if(data.ok){ toast('‚úÖ Audit saved'); closeAuditModal(); loadAll(); }
    else{ toast('‚ö†Ô∏è Could not save audit'); }
  }catch(e){ toast('‚ö†Ô∏è Save failed'); }
}

/* -------- Search -------- */
qs('#searchBox').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  if(!q) return renderQueue(ALL_ALERTS);
  const out = ALL_ALERTS.filter(r=>
    (r.title||r.ticket||'').toLowerCase().includes(q) ||
    (r.owner||'').toLowerCase().includes(q) ||
    (r.issues? (typeof r.issues==='string'? r.issues : JSON.stringify(r.issues)) : '').toLowerCase().includes(q) ||
    (r.status||'').toLowerCase().includes(q)
  );
  renderQueue(out);
});

/* -------- Wire up -------- */
document.getElementById('btnOpenQuickAudit').onclick = ()=> openAuditModal();
document.getElementById('panelQuickAudit').onclick   = ()=> openAuditModal();
document.getElementById('btnRandomAudit').onclick    = async ()=>{
  try{
    const d = await API.random();
    if(d && d.ticket){ openAuditModal(d); toast('üé≤ Random ticket loaded');}
    else { openAuditModal(); toast('No candidates ‚Äî enter an ID'); }
  }catch(_){ openAuditModal(); toast('No candidates ‚Äî enter an ID'); }
};
document.getElementById('panelRandomAudit').onclick  = document.getElementById('btnRandomAudit').onclick;
document.getElementById('btnInsights').onclick       = ()=> window.open(INSIGHTS_URL,'_blank');
document.getElementById('panelInsights').onclick     = ()=> window.open(INSIGHTS_URL,'_blank');
document.getElementById('btnRefresh').onclick        = loadAll;
document.getElementById('btnSaveAudit').onclick      = saveAudit;
document.getElementById('btnRandomFill').onclick     = document.getElementById('btnRandomAudit').onclick;
document.getElementById('btnCloseModal').onclick     = ()=> backdrop.classList.remove('show');

/* -------- Slack helper link -------- */
qs('#slackUrl').textContent =
  `${SITE_URL}?slack=1&ticket=01-ABC123&by=carol@org.com&token=${TOKEN}`;

/* -------- Slack mini resolve page -------- */
(function(){
  const sp = new URLSearchParams(location.search);
  if (sp.get('slack')==='1'){
    qs('#app').style.display='none';
    const mini = document.getElementById('slackMini'); mini.style.display='block';
    const card = document.getElementById('slackMiniCard');
    const ticket = sp.get('ticket')||''; const by = sp.get('by')||'slack-user'; const tok = sp.get('token')||TOKEN;
    card.innerHTML = `Resolving <b>${ticket||'(unknown ticket)'}</b>‚Ä¶`;

    (async()=>{
      try{
        const data = await jsonp('resolve', { ticket, by, token: tok });
        if (data.ok){ card.innerHTML = `‚úÖ Resolved <b>${ticket}</b>. Redirecting‚Ä¶`; }
        else { card.innerHTML = `‚ö†Ô∏è Could not resolve <b>${ticket}</b>.`; }
      }catch(e){
        card.innerHTML = `‚ö†Ô∏è Resolve failed for <b>${ticket}</b>.`;
      }
      const redirect = sp.get('redirect') || SITE_URL;
      setTimeout(()=>{ location.href = redirect; }, 1200);
    })();
  }
})();

/* -------- Boot -------- */
loadAll();
setInterval(async()=>{ try{ const d=await API.recent(); renderRecent(d.rows||d.data||d||[]);}catch(_){ } }, 10000);
</script>
</body>
</html>
